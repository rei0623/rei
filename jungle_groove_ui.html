<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jungle Groove - Wild Music Safari</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* jungle_groove_styles.css - Updated */
        :root {
            --jg-bg-deep-jungle: #0A192F; /* Deep Navy Blue */
            --jg-bg-forest-floor: #172A46; /* Slightly Lighter Navy */
            --jg-surface-bark: #2A3B52;   /* Muted Blue-Gray for surfaces */
            --jg-surface-leaf: #4A6080;   /* Lighter Muted Blue-Gray */

            --jg-accent-sunburst: #FFB703; /* Vibrant Yellow/Orange */
            --jg-accent-canopy: #64FFDA;   /* Bright Aqua/Neon Green */
            --jg-accent-waterfall: #00B4D8; /* Clear, Vibrant Blue */
            
            --jg-text-light: #CCD6F6;     /* Light Lavender/Off-white */
            --jg-text-earth: #A8B2D1;     /* Lighter Gray/Blue for secondary */
            --jg-text-shadow: #8892B0;    /* Muted Text / Placeholder */
            
            --jg-border-vine: #2A3B52;    /* Darker border, same as surface-bark */
            
            --jg-shadow-heavy: rgba(2, 12, 27, 0.7); /* Darker, subtle shadow */
            --jg-shadow-light: rgba(2, 12, 27, 0.3);
            --jg-shadow-glow-canopy: rgba(100, 255, 218, 0.15);
            --jg-shadow-glow-sunburst: rgba(255, 183, 3, 0.15);

            --font-display-jg: 'Kalam', cursive;
            --font-body-jg: 'Montserrat', sans-serif;

            --jg-surface-bark-rgb: 42, 59, 82;
            --jg-surface-leaf-rgb: 74, 96, 128;
            --jg-bg-forest-floor-rgb: 23, 42, 70;
            --jg-accent-canopy-rgb: 100, 255, 218;
            --jg-accent-sunburst-rgb: 255, 183, 3;
            --jg-accent-waterfall-rgb: 0, 180, 216;

            --jg-placeholder-bg: var(--jg-surface-leaf);

            --border-radius-small: 6px;
            --border-radius-medium: 10px;
            --border-radius-large: 16px;
            --border-radius-player: 20px;
            --transition-fast: 0.2s ease-out;
            --transition-medium: 0.3s ease-out;
        }

        body.jungle-theme {
            font-family: var(--font-body-jg);
            background: linear-gradient(180deg, var(--jg-bg-deep-jungle) 0%, #0E2038 100%);
            color: var(--jg-text-light);
            margin: 0;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .jungle-background-layers { position: fixed; inset: 0; z-index: -1; pointer-events: none;}
        .jungle-background-layers .layer {
            position: absolute; inset: 0;
            transition: transform 0.7s cubic-bezier(0.25, 0.1, 0.25, 1), opacity 0.7s ease;
        }
        .layer-1 {
            background: radial-gradient(ellipse at bottom, rgba(var(--jg-accent-canopy-rgb), 0.05) 0%, transparent 60%);
            opacity: 0.7;
        }
        .layer-2 {
            background: radial-gradient(ellipse at top right, rgba(var(--jg-accent-sunburst-rgb), 0.03) 0%, transparent 50%);
            opacity: 0.5;
            transform: scale(1.03);
        }
        .layer-3 { /* Placeholder for potential future use, e.g., subtle animated particles */
            opacity: 0; 
        }


        .app-safari-hut {
            width: 95vw;
            height: 90vh;
            max-width: 1500px;
            max-height: 850px;
            margin: 2.5vh auto;
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.6); /* Darker, more transparent */
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(var(--jg-surface-bark-rgb), 0.3);
            border-radius: var(--border-radius-player);
            box-shadow: 0 20px 50px var(--jg-shadow-heavy), 0 0 0 1px rgba(var(--jg-surface-leaf-rgb),0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: background-color var(--transition-medium), border-color var(--transition-medium);
        }

        .safari-map-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1.5rem; /* Adjusted padding */
            background-color: rgba(var(--jg-bg-deep-jungle-rgb), 0.5); /* More subtle */
            border-bottom: 1px solid rgba(var(--jg-surface-bark-rgb), 0.2);
            box-shadow: 0 2px 10px rgba(var(--jg-shadow-heavy), 0.3);
            flex-shrink: 0;
        }
        .compass-logo {
            font-family: var(--font-display-jg);
            font-size: 1.5rem; /* Slightly smaller */
            font-weight: 700;
            color: var(--jg-text-light);
            letter-spacing: 0.5px;
        }
        .compass-logo i { color: var(--jg-accent-canopy); margin-right: 0.6rem; transform: rotate(-10deg); }
        .text-accent-jg { color: var(--jg-accent-canopy); }

        .search-outpost {
            display: flex;
            align-items: center;
            background-color: rgba(var(--jg-surface-bark-rgb), 0.3);
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius-medium);
            border: 1px solid rgba(var(--jg-surface-bark-rgb), 0.2);
            transition: background-color var(--transition-fast), border-color var(--transition-fast);
        }
        .search-outpost:focus-within {
            background-color: rgba(var(--jg-surface-bark-rgb), 0.5);
            border-color: var(--jg-accent-canopy);
            box-shadow: 0 0 0 2px var(--jg-shadow-glow-canopy);
        }
        .search-outpost i { color: var(--jg-text-shadow); margin-right: 0.7rem; font-size: 0.9rem; }
        #animal-tracker {
            background: transparent; border: none; outline: none;
            color: var(--jg-text-light); font-size: 0.9rem; width: 250px;
            letter-spacing: 0.3px;
        }
        #animal-tracker::placeholder { color: var(--jg-text-shadow); opacity: 0.8; }

        .safari-tools { display: flex; align-items: center; gap: 0.8rem; }
        .tool-btn-jg {
            background-color: transparent;
            border: 1px solid rgba(var(--jg-surface-bark-rgb),0.5);
            color: var(--jg-text-earth);
            width: 38px; height: 38px; /* Slightly smaller */
            border-radius: var(--border-radius-medium);
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 1rem;
            transition: all var(--transition-fast);
            box-shadow: 0 1px 3px var(--jg-shadow-light);
        }
        .tool-btn-jg:hover {
            background-color: rgba(var(--jg-accent-canopy-rgb), 0.2);
            color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px var(--jg-shadow-glow-canopy);
        }
        .tool-btn-jg.profile .profile-avatar-placeholder {
            width: 28px; height: 28px; border-radius: 50%;
            background-color: var(--jg-text-shadow);
        }

        .safari-zone {
            flex-grow: 1;
            display: flex;
            padding: 1.5rem;
            gap: 1.5rem;
            overflow: hidden;
        }

        .watering-hole-player {
            flex: 3;
            background: linear-gradient(145deg, rgba(var(--jg-surface-bark-rgb),0.15), rgba(var(--jg-bg-forest-floor-rgb),0.2));
            border-radius: var(--border-radius-large);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: inset 0 1px 2px rgba(var(--jg-shadow-light),0.5), inset 0 0 20px rgba(var(--jg-bg-deep-jungle-rgb), 0.2);
            border: 1px solid rgba(var(--jg-surface-bark-rgb), 0.15);
            transition: background var(--transition-medium), border-color var(--transition-medium);
        }
        .album-canopy {
            width: 280px; height: 280px;
            border-radius: var(--border-radius-medium);
            margin-bottom: 1.8rem; /* Increased margin */
            position: relative;
            box-shadow: 0 10px 30px var(--jg-shadow-heavy), 0 0 0 1px rgba(var(--jg-surface-leaf-rgb),0.1);
            overflow: hidden;
            background-color: var(--jg-bg-forest-floor);
            transition: transform var(--transition-medium), box-shadow var(--transition-medium);
        }
        .watering-hole-player.is-playing .album-canopy {
             transform: scale(1.02);
             box-shadow: 0 12px 35px var(--jg-shadow-heavy), 0 0 15px var(--jg-shadow-glow-canopy);
        }
        #main-album-art-jg { /* Applied to img tag now */
            width: 100%; height: 100%; object-fit: cover;
            border-radius: var(--border-radius-medium); /* Match parent */
        }
        #main-album-art-jg.album-art-placeholder {
            border: none; /* Remove border, bg is enough */
            background-color: var(--jg-surface-bark);
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; color: rgba(var(--jg-text-light-rgb), 0.3);
        }
        .leaf-overlay { display: none; /* Simplification, can be re-added with better assets */ }

        .track-details-jg { text-align: center; margin-bottom: 1.8rem; }
        #song-title-jg {
            font-family: var(--font-body-jg); /* Changed from display font for readability */
            font-size: 1.8rem; font-weight: 700; /* Adjusted size and weight */
            color: var(--jg-text-light); margin-bottom: 0.4rem;
            min-height: 1.2em;
            letter-spacing: 0.5px;
        }
        #artist-name-jg {
            font-size: 1rem; color: var(--jg-text-earth);
            min-height: 1.2em;
            font-weight: 500;
        }

        .player-controls-jg { display: flex; align-items: center; gap: 1.2rem; margin-bottom: 2rem; }
        .control-rock {
            background-color: transparent;
            border: 2px solid var(--jg-surface-leaf);
            color: var(--jg-text-earth);
            border-radius: 50%;
            width: 56px; height: 56px; /* Slightly smaller */
            font-size: 1.1rem;
            display: inline-flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px var(--jg-shadow-light);
            transition: all var(--transition-fast);
            text-shadow: none; /* Removed text-shadow for cleaner look */
        }
        .control-rock:hover {
            border-color: var(--jg-accent-canopy);
            color: var(--jg-accent-canopy);
            transform: scale(1.05);
            box-shadow: 0 4px 10px var(--jg-shadow-glow-canopy);
        }
        .control-rock:active { transform: scale(0.98); box-shadow: 0 1px 3px var(--jg-shadow-light); }
        .control-rock.small { width: 44px; height: 44px; font-size: 0.9rem; }
        .control-rock.play {
            width: 70px; height: 70px; font-size: 1.8rem;
            background-color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
            color: var(--jg-bg-deep-jungle); /* Dark text on bright button */
            box-shadow: 0 5px 15px var(--jg-shadow-glow-canopy);
        }
        .control-rock.play:hover {
            background-color: var(--jg-accent-canopy); /* Keep color on hover */
            border-color: var(--jg-accent-canopy);
            color: var(--jg-bg-deep-jungle);
            transform: scale(1.08); /* Larger pop for play button */
            box-shadow: 0 8px 20px var(--jg-shadow-glow-canopy);
        }

        .progress-liana-jg { display: flex; align-items: center; gap: 1rem; width: 100%; max-width: 450px; margin-bottom: 1.5rem; }
        .progress-liana-jg span { font-size: 0.8rem; color: var(--jg-text-shadow); width: 35px; text-align: center; }
        
        .liana-slider {
            -webkit-appearance: none; appearance: none; flex-grow: 1; height: 6px; /* Slimmer */
            background-color: var(--jg-surface-bark);
            border-radius: 3px; cursor: pointer;
            outline: none;
            transition: background-color var(--transition-fast);
        }
        .liana-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; /* Slightly larger */
            background-color: var(--jg-accent-canopy);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--jg-shadow-glow-canopy);
            transition: transform var(--transition-fast);
        }
        .liana-slider:hover::-webkit-slider-thumb { transform: scale(1.2); }
        .liana-slider::-moz-range-thumb { /* Firefox */
            width: 16px; height: 16px;
            background-color: var(--jg-accent-canopy);
            border: none; border-radius: 50%;
            box-shadow: 0 0 5px var(--jg-shadow-glow-canopy);
            cursor: pointer;
        }
         .liana-slider::-moz-range-track { /* Firefox */
            height: 6px;
            background-color: var(--jg-surface-bark);
            border-radius: 3px;
        }


        .volume-fruit-jg { display: flex; align-items: center; gap: 0.6rem; }
        .animal-icon { font-size: 1.1rem; color: var(--jg-text-shadow); transition: color var(--transition-fast); }
        .volume-fruit-jg:hover .animal-icon { color: var(--jg-text-earth); }
        .fruit-slider {
            -webkit-appearance: none; appearance: none; width: 100px; height: 5px; /* Slimmer */
            background: var(--jg-surface-bark); border-radius: 2.5px; cursor: pointer; outline: none;
        }
        .fruit-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
            background: var(--jg-accent-sunburst);
            border-radius: 50%; border: none;
            box-shadow: 0 0 5px var(--jg-shadow-glow-sunburst);
            transition: transform var(--transition-fast);
        }
        .fruit-slider:hover::-webkit-slider-thumb { transform: scale(1.2); }
         .fruit-slider::-moz-range-thumb { /* Firefox */
            width: 14px; height: 14px;
            background: var(--jg-accent-sunburst);
            border: none; border-radius: 50%;
            box-shadow: 0 0 5px var(--jg-shadow-glow-sunburst);
            cursor: pointer;
        }
        .fruit-slider::-moz-range-track { /* Firefox */
            height: 5px;
            background-color: var(--jg-surface-bark);
            border-radius: 2.5px;
        }


        .explorers-log {
            flex: 2;
            background-color: rgba(var(--jg-surface-bark-rgb), 0.1); /* More subtle background */
            border-radius: var(--border-radius-large);
            border: 1px solid rgba(var(--jg-surface-bark-rgb), 0.15);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color var(--transition-medium), border-color var(--transition-medium);
        }
        .log-tabs-jg { display: flex; border-bottom: 1px solid rgba(var(--jg-surface-bark-rgb),0.2); margin-bottom: 1rem; }
        .log-tab-jg {
            flex-grow: 1; padding: 0.8rem 0.5rem; /* Adjusted padding */
            font-family: var(--font-body-jg); font-size: 0.9rem; font-weight: 600; /* Changed font */
            color: var(--jg-text-earth); border: none; background: transparent;
            position: relative; opacity: 0.7;
            transition: opacity var(--transition-fast), color var(--transition-fast);
            cursor: pointer; text-align: center;
        }
        .log-tab-jg:hover { opacity: 1; color: var(--jg-accent-canopy); }
        .log-tab-jg.active {
            opacity: 1; color: var(--jg-accent-canopy); font-weight: 700;
        }
        .log-tab-jg.active::after {
            content: ''; position: absolute;
            bottom: -1px; /* Align with border */ left: 15%; width: 70%; height: 2px;
            background-color: var(--jg-accent-canopy); border-radius: 1px;
            box-shadow: 0 0 8px var(--jg-shadow-glow-canopy);
        }
        .log-tab-jg i { margin-right: 0.5rem; font-size: 0.9em; }
        #queue-count-jg {
            background: var(--jg-accent-waterfall); color: var(--jg-bg-deep-jungle); font-size: 0.65rem; font-weight: bold;
            padding: 2px 6px; border-radius: var(--border-radius-small); margin-left: 0.4rem;
            font-family: var(--font-body-jg);
            box-shadow: 0 0 5px rgba(var(--jg-accent-waterfall-rgb),0.5);
        }

        .log-content-jg { flex-grow: 1; overflow-y: auto; padding-right: 5px; /* For scrollbar */ }
        /* Custom scrollbar for webkit browsers */
        .log-content-jg::-webkit-scrollbar { width: 8px; }
        .log-content-jg::-webkit-scrollbar-track { background: rgba(var(--jg-surface-bark-rgb),0.1); border-radius: 4px; }
        .log-content-jg::-webkit-scrollbar-thumb { background: var(--jg-surface-leaf); border-radius: 4px; }
        .log-content-jg::-webkit-scrollbar-thumb:hover { background: var(--jg-accent-canopy); }

        .log-panel-jg { display: none; padding-top: 0.5rem; }
        .log-panel-jg.active { display: block; animation: revealPanel 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        @keyframes revealPanel { from { opacity:0; transform:translateY(10px) scale(0.98); } to { opacity:1; transform:translateY(0) scale(1); } }

        .log-entry-jg {
            display: flex; align-items: center; padding: 0.7rem; /* Adjusted padding */
            margin-bottom: 0.6rem; border-radius: var(--border-radius-medium);
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.3);
            border: 1px solid transparent;
            transition: background-color var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
            cursor: pointer;
        }
        .log-entry-jg:hover {
            background-color: rgba(var(--jg-surface-leaf-rgb),0.25);
            transform: translateY(-2px);
            border-color: rgba(var(--jg-accent-canopy-rgb),0.3);
            box-shadow: 0 3px 10px var(--jg-shadow-glow-canopy);
        }
        .log-entry-jg.active-song {
            background-color: rgba(var(--jg-accent-canopy-rgb),0.2);
            border-left: 3px solid var(--jg-accent-canopy); /* Changed to left border */
            padding-left: calc(0.7rem - 3px);
            box-shadow: 0 0 10px var(--jg-shadow-glow-canopy);
        }
        .log-entry-jg > img,
        .log-entry-jg .img-placeholder.list-thumb-placeholder {
            width: 42px; height: 42px; border-radius: var(--border-radius-small); margin-right: 0.8rem;
            object-fit: cover; flex-shrink: 0;
            background-color: var(--jg-surface-leaf); /* Placeholder bg for img tag if src fails */
        }
         .log-entry-jg .img-placeholder.list-thumb-placeholder { /* For explicit placeholders */
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: rgba(var(--jg-text-light-rgb),0.3);
        }
        .log-entry-jg > div { flex-grow: 1; overflow:hidden; }
        .log-entry-jg .title { display: block; font-weight: 600; font-size: 0.9rem; color: var(--jg-text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom: 2px; }
        .log-entry-jg .artist { display: block; font-size: 0.8rem; color: var(--jg-text-earth); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .log-entry-jg .duration { font-size: 0.8rem; color: var(--jg-text-shadow); margin-left: auto; padding-left:0.7rem; flex-shrink: 0; }
        
        .log-entry-jg > button.song-item-action-jg {
            background: none; border: none; padding: 0.5rem; margin-left: 0.3rem; /* Smaller margin */
            cursor: pointer; flex-shrink: 0;
        }
        .log-entry-jg > button.song-item-action-jg i {
            font-size: 1rem; color: var(--jg-text-shadow); transition: color var(--transition-fast), transform var(--transition-fast);
        }
        .log-entry-jg:hover > button.song-item-action-jg i,
        .log-entry-jg > button.song-item-action-jg i.fa-heart { /* Keep favorite highlighted */
             color: var(--jg-accent-sunburst);
        }
        .log-entry-jg > button.song-item-action-jg:hover i {
            transform: scale(1.2);
        }


        .log-actions-jg {
            padding-top: 1rem; border-top: 1px solid rgba(var(--jg-surface-bark-rgb),0.2);
            display: flex; gap: 0.8rem; justify-content: center;
            margin-top: auto; /* Push to bottom */
        }
        .log-actions-jg button {
            background-color: rgba(var(--jg-surface-leaf-rgb), 0.3);
            color: var(--jg-text-earth);
            padding: 0.6rem 1.2rem; border-radius: var(--border-radius-medium);
            border: 1px solid rgba(var(--jg-surface-leaf-rgb),0.5);
            font-size: 0.8rem; font-weight: 600;
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        .log-actions-jg button:hover {
            background-color: rgba(var(--jg-accent-canopy-rgb), 0.25);
            color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
            transform: translateY(-1px); box-shadow: 0 2px 8px var(--jg-shadow-glow-canopy);
        }
        .log-actions-jg button i { margin-right: 0.5rem; }

        .control-rock.active-control {
            color: var(--jg-accent-sunburst) !important;
            border-color: var(--jg-accent-sunburst) !important; /* Ensure specificity */
            box-shadow: 0 0 12px var(--jg-shadow-glow-sunburst);
        }
        .loop-indicator-jg {
            position: absolute;
            top: 2px; right: 2px; font-size: 0.55rem; font-weight: bold;
            background-color: var(--jg-accent-sunburst); color: var(--jg-bg-deep-jungle);
            border-radius: 50%; width: 11px; height: 11px;
            line-height: 11px; text-align: center; font-family: var(--font-body-jg);
            box-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .img-placeholder {
            display: inline-block;
            background-color: var(--jg-placeholder-bg);
            object-fit: cover;
        }

        /* Light Mode Styles */
        body.light-mode-jg {
            --jg-bg-deep-jungle: #F0F4F8; /* Light Grayish Blue */
            --jg-bg-forest-floor: #FFFFFF; 
            --jg-surface-bark: #DDE2E8;
            --jg-surface-leaf: #CBD2DB;

            --jg-accent-sunburst: #F57C00; /* Darker Orange for contrast */
            --jg-accent-canopy: #00796B;   /* Darker Teal/Green */
            --jg-accent-waterfall: #0288D1;
            
            --jg-text-light: #263238;      /* Dark Gray for text */
            --jg-text-earth: #455A64;
            --jg-text-shadow: #78909C;
            
            --jg-border-vine: #B0BEC5;
            
            --jg-shadow-heavy: rgba(100, 110, 120, 0.2);
            --jg-shadow-light: rgba(100, 110, 120, 0.1);
            --jg-shadow-glow-canopy: rgba(0, 121, 107, 0.2);
            --jg-shadow-glow-sunburst: rgba(245, 124, 0, 0.2);


            --jg-surface-bark-rgb: 221, 226, 232;
            --jg-surface-leaf-rgb: 203, 210, 219;
            --jg-bg-forest-floor-rgb: 255, 255, 255;
            --jg-accent-canopy-rgb: 0, 121, 107;
            --jg-accent-sunburst-rgb: 245, 124, 0;
            --jg-accent-waterfall-rgb: 2, 136, 209;
        }

        body.light-mode-jg .app-safari-hut {
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.8);
            border-color: rgba(var(--jg-surface-bark-rgb), 0.7);
            box-shadow: 0 15px 40px var(--jg-shadow-heavy), 0 0 0 1px rgba(var(--jg-surface-leaf-rgb),0.3);
        }
        body.light-mode-jg .safari-map-bar {
            background-color: rgba(255,255,255,0.7);
            border-bottom-color: var(--jg-border-vine);
        }
        body.light-mode-jg .search-outpost {
            background-color: var(--jg-surface-bark);
            border-color: var(--jg-border-vine);
        }
        body.light-mode-jg .search-outpost:focus-within {
            background-color: var(--jg-surface-bark);
            border-color: var(--jg-accent-canopy);
        }
        body.light-mode-jg .tool-btn-jg {
            border-color: var(--jg-border-vine);
        }
        body.light-mode-jg .tool-btn-jg:hover {
            background-color: rgba(var(--jg-accent-canopy-rgb), 0.1);
            border-color: var(--jg-accent-canopy);
        }
        body.light-mode-jg .watering-hole-player {
            background: linear-gradient(145deg, #FAFCFF, #F0F4F8);
            border-color: var(--jg-border-vine);
        }
        body.light-mode-jg #main-album-art-jg.album-art-placeholder {
            background-color: var(--jg-surface-bark);
            color: rgba(var(--jg-text-light-rgb), 0.5);
        }
        body.light-mode-jg .control-rock {
            border-color: var(--jg-surface-leaf);
            color: var(--jg-text-earth);
        }
        body.light-mode-jg .control-rock:hover {
            border-color: var(--jg-accent-canopy);
            color: var(--jg-accent-canopy);
        }
        body.light-mode-jg .control-rock.play {
            background-color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
            color: #FFFFFF; /* Light text on dark button */
        }
        body.light-mode-jg .liana-slider,
        body.light-mode-jg .liana-slider::-moz-range-track { background-color: var(--jg-surface-bark); }
        body.light-mode-jg .liana-slider::-webkit-slider-thumb,
        body.light-mode-jg .liana-slider::-moz-range-thumb { background-color: var(--jg-accent-canopy); }

        body.light-mode-jg .fruit-slider,
        body.light-mode-jg .fruit-slider::-moz-range-track { background: var(--jg-surface-bark); }
        body.light-mode-jg .fruit-slider::-webkit-slider-thumb,
        body.light-mode-jg .fruit-slider::-moz-range-thumb { background: var(--jg-accent-sunburst); }
        
        body.light-mode-jg .explorers-log {
            background-color: rgba(var(--jg-surface-bark-rgb), 0.3);
            border-color: var(--jg-border-vine);
        }
        body.light-mode-jg .log-tabs-jg { border-bottom-color: var(--jg-border-vine); }
        body.light-mode-jg .log-tab-jg:hover,
        body.light-mode-jg .log-tab-jg.active { color: var(--jg-accent-canopy); }
        body.light-mode-jg .log-tab-jg.active::after { background-color: var(--jg-accent-canopy); }
        
        body.light-mode-jg .log-content-jg::-webkit-scrollbar-track { background: rgba(var(--jg-surface-bark-rgb),0.3); }
        body.light-mode-jg .log-content-jg::-webkit-scrollbar-thumb { background: var(--jg-surface-leaf); }
        body.light-mode-jg .log-content-jg::-webkit-scrollbar-thumb:hover { background: var(--jg-accent-canopy); }

        body.light-mode-jg .log-entry-jg {
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.7);
        }
        body.light-mode-jg .log-entry-jg:hover {
            background-color: rgba(var(--jg-surface-leaf-rgb),0.5);
            border-color: rgba(var(--jg-accent-canopy-rgb),0.5);
        }
        body.light-mode-jg .log-entry-jg.active-song {
            background-color: rgba(var(--jg-accent-canopy-rgb),0.15);
            border-left-color: var(--jg-accent-canopy);
        }
        body.light-mode-jg .log-entry-jg > img,
        body.light-mode-jg .log-entry-jg .img-placeholder.list-thumb-placeholder {
            background-color: var(--jg-surface-leaf);
        }
        body.light-mode-jg .log-actions-jg { border-top-color: var(--jg-border-vine); }
        body.light-mode-jg .log-actions-jg button {
            background-color: rgba(var(--jg-surface-leaf-rgb), 0.6);
            border-color: rgba(var(--jg-surface-leaf-rgb),1);
        }
        body.light-mode-jg .log-actions-jg button:hover {
            background-color: rgba(var(--jg-accent-canopy-rgb), 0.2);
            color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
        }

        @media (max-width: 1024px) {
            .app-safari-hut { width: 100vw; height: 100vh; margin: 0; border-radius: 0; max-height: none; border: none; box-shadow: none; }
            .safari-zone { flex-direction: column; padding: 1rem; gap: 1rem;}
            .watering-hole-player { flex: 0 1 auto; padding: 1.5rem; min-height: auto; max-height: 55vh;} /* Adjusted flex for mobile */
            .album-canopy { width: 180px; height: 180px; margin-bottom: 1rem;}
            #song-title-jg { font-size: 1.5rem; }
            #artist-name-jg { font-size: 0.9rem; }
            .explorers-log { flex: 1 1 auto; min-height: 250px;} /* Ensure log has space */
            #animal-tracker { width: 180px; }
            .player-controls-jg { margin-bottom: 1.5rem; gap: 1rem; }
            .progress-liana-jg { max-width: 100%; }
        }
        @media (max-width: 767px) {
            .safari-map-bar { padding: 0.6rem 1rem; }
            .compass-logo { font-size: 1.3rem;}
            .search-outpost { display: none; /* Hide search on very small screens to save space */ }
            .tool-btn-jg { width: 36px; height: 36px; font-size: 0.9rem; }
            .safari-zone { padding: 0.75rem; gap: 0.75rem; }
            .watering-hole-player { padding: 1rem; max-height: none; /* Allow it to grow more if needed */ }
            .album-canopy { width: clamp(120px, 40vw, 150px); height: clamp(120px, 40vw, 150px); margin-bottom: 0.8rem; }
            #main-album-art-jg.album-art-placeholder { font-size: 2.5rem; }
            #song-title-jg { font-size: 1.3rem; }
            #artist-name-jg { font-size: 0.85rem; }
            .player-controls-jg { gap: 0.75rem; margin-bottom: 1rem; }
            .control-rock { width: 48px; height: 48px; font-size: 1rem; }
            .control-rock.small { width: 38px; height: 38px; font-size: 0.8rem; }
            .control-rock.play { width: 60px; height: 60px; font-size: 1.6rem; }
            .log-tabs-jg { margin-bottom: 0.75rem; }
            .log-tab-jg { font-size: 0.8rem; padding: 0.6rem 0.2rem; }
            .log-tab-jg i { margin-right: 0.3rem; }
            .log-entry-jg { padding: 0.6rem; margin-bottom: 0.5rem;}
            .log-entry-jg > img,
            .log-entry-jg .img-placeholder.list-thumb-placeholder { width: 36px; height: 36px; margin-right: 0.6rem;}
            .log-entry-jg .title { font-size: 0.85rem;}
            .log-entry-jg .artist { font-size: 0.75rem;}
            .log-actions-jg button { padding: 0.5rem 1rem; font-size: 0.75rem;}
        }
    </style>
</head>
<body class="jungle-theme">

    <div class="jungle-background-layers">
        <div class="layer layer-1"></div>
        <div class="layer layer-2"></div>
        <div class="layer layer-3"></div>
    </div>

    <div class="app-safari-hut">

        <header class="safari-map-bar">
            <div class="compass-logo">
                <i class="fas fa-compact-disc"></i> <!-- Changed icon -->
                <span>Jungle<span class="text-accent-jg">Groove</span></span>
            </div>
            <div class="search-outpost">
                <i class="fas fa-search"></i> <!-- Changed icon -->
                <input type="text" id="animal-tracker" placeholder="Track your tunes...">
            </div>
            <div class="safari-tools">
                <button id="weather-toggle" class="tool-btn-jg" title="Toggle Ambience (Theme)"><i class="fas fa-lightbulb"></i></button> <!-- Changed icon -->
                <button id="profile-ranger" class="tool-btn-jg profile" title="Profile">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238892B0'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Ranger Profile" class="profile-avatar-placeholder">
                </button>
            </div>
        </header>

        <main class="safari-zone">
            <section class="watering-hole-player">
                <div class="album-canopy">
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Album Art" id="main-album-art-jg" class="album-art-placeholder">
                    <div class="leaf-overlay"></div>
                </div>
                <div class="track-details-jg">
                    <h2 id="song-title-jg">Wild Rhythms</h2>
                    <p id="artist-name-jg">The Jungle Cats</p>
                </div>
                <div class="player-controls-jg">
                    <button class="control-rock small" id="btn-shuffle-jg" title="Shuffle"><i class="fas fa-random"></i></button>
                    <button class="control-rock" id="btn-prev-jg" title="Previous"><i class="fas fa-step-backward"></i></button>
                    <button class="control-rock play" id="btn-play-jg" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-rock" id="btn-next-jg" title="Next"><i class="fas fa-step-forward"></i></button>
                    <button class="control-rock small" id="btn-loop-jg" title="Loop"><i class="fas fa-redo-alt"></i></button>
                </div>
                <div class="progress-liana-jg">
                    <span id="current-time-jg">0:00</span>
                    <input type="range" id="progress-slider-jg" class="liana-slider" value="0" title="Seek" min="0" max="100" step="0.1">
                    <span id="total-time-jg">0:00</span>
                </div>
                <div class="volume-fruit-jg">
                    <i class="fas fa-volume-down animal-icon monkey" title="Volume"></i> <!-- Changed one icon for consistency -->
                    <input type="range" id="volume-slider-jg" class="fruit-slider" value="75" min="0" max="100" title="Volume">
                    <!-- <i class="fas fa-volume-up animal-icon parrot"></i> Removed one icon to simplify -->
                </div>
            </section>

            <aside class="explorers-log">
                <div class="log-tabs-jg">
                    <button class="log-tab-jg active" data-panel="log-library"><i class="fas fa-music"></i> Library</button>
                    <button class="log-tab-jg" data-panel="log-paths"><i class="fas fa-stream"></i> Playlists</button>
                    <button class="log-tab-jg" data-panel="log-discoveries"><i class="fas fa-list-ol"></i> Queue <span id="queue-count-jg">0</span></button>
                    <button class="log-tab-jg" data-panel="log-trophies"><i class="fas fa-star"></i> Favorites</button> <!-- Changed icon -->
                    <button class="log-tab-jg" data-panel="log-history"><i class="fas fa-history"></i> History</button>
                </div>
                <div class="log-content-jg">
                    <div id="log-library" class="log-panel-jg active">
                        <!-- Example static items (JS populates this) -->
                        <div class="log-entry-jg">
                            <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Song Thumbnail" class="img-placeholder list-thumb-placeholder">
                            <div><span class="title">King of the Beats</span><span class="artist">Leo Roars</span></div>
                            <span class="duration">3:15</span>
                            <button class="song-item-action-jg" aria-label="Favorite"> <i class="far fa-heart"></i></button> <!-- Use far for non-favorited -->
                        </div>
                    </div>
                    <div id="log-paths" class="log-panel-jg">
                         <div class="text-center p-8 text-jg-text-shadow">
                            <i class="fas fa-stream fa-3x mb-4 opacity-50"></i>
                            <h4 class="font-display-jg text-xl text-jg-text-earth mb-2">No Paths Yet</h4>
                            <p class="text-sm">Create playlists to map your musical journeys!</p>
                        </div>
                    </div>
                    <div id="log-discoveries" class="log-panel-jg"></div>
                    <div id="log-trophies" class="log-panel-jg"></div>
                    <div id="log-history" class="log-panel-jg"></div>
                </div>
                 <div class="log-actions-jg">
                    <button id="btn-refresh-feed-jg"><i class="fas fa-sync-alt"></i> Refresh</button> <!-- Shorter text -->
                    <button id="btn-create-playlist-jg"><i class="fas fa-plus"></i> New Path</button> <!-- Shorter text -->
                </div>
            </aside>
        </main>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // jungle_groove_script.js
        // (JavaScript remains largely the same as provided in the prompt, with minor adjustments if needed for new class names or simplified HTML)
        console.log("jungle_groove_script.js parsing started. Waiting for YouTube API...");

        let elementsJG = {};
        let appStateJG = {};

        function onYouTubeIframeAPIReady() {
            console.log("GLOBAL onYouTubeIframeAPIReady CALLED BY YOUTUBE API SCRIPT!");
            if (Object.keys(elementsJG).length === 0 || !elementsJG.youtubePlayerContainer) {
                console.warn("onYouTubeIframeAPIReady: elementsJG not fully initialized. Initializing now.");
                initializeElementsJG();
            }
            if (!elementsJG.youtubePlayerContainer) {
                 console.error("onYouTubeIframeAPIReady: Still no youtubePlayerContainer. Player cannot be created.");
                 if (typeof showSnackbarJG === 'function') {
                    showSnackbarJG("プレイヤー表示領域が見つかりません。", "error");
                 } else {
                    alert("プレイヤー表示領域が見つかりません。");
                 }
                 return;
            }
            try {
                if (Object.keys(appStateJG).length < 5) {
                    console.warn("onYouTubeIframeAPIReady: appStateJG seems partially initialized, re-setting basic player state.");
                    appStateJG.player = null;
                    appStateJG.isPlayerReady = false;
                    appStateJG.volume = appStateJG.volume || 75;
                }
                appStateJG.player = new YT.Player(elementsJG.youtubePlayerContainer.id, {
                    height: '1', width: '1',
                    playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1, 'origin': window.location.origin },
                    events: { 'onReady': onPlayerReadyJG, 'onStateChange': onPlayerStateChangeJG, 'onError': onPlayerErrorJG }
                });
                console.log("onYouTubeIframeAPIReady: YT.Player instance creation attempted.");
            } catch (e) {
                console.error("onYouTubeIframeAPIReady: Error creating YT.Player instance:", e);
                const message = "YouTubeプレイヤーの作成中にエラー: " + e.message;
                if (typeof showSnackbarJG === 'function') { showSnackbarJG(message, "error"); } else { alert(message); }
            }
        }

        const MAX_HISTORY_JG = 20;
        const LS_KEYS_JG = { HISTORY: 'jungleGrooveHistory', FAVORITES: 'jungleGrooveFavorites', PLAYLISTS: 'jungleGroovePlaylists', THEME: 'jungleGrooveTheme', QUEUE: 'jungleGrooveQueue' };

        appStateJG = {
            player: null, songs: [], filteredSongs: [], currentSongIndex: -1, isPlaying: false,
            isShuffle: false, loopMode: 'none', currentPanel: 'log-library', volume: 75,
            progressInterval: null, history: [], favorites: [], userPlaylists: [], queue: [],
            currentQueueIndex: -1, playMode: 'library', isPlayerReady: false, snackbarTimeoutId: null,
            currentTheme: 'dark'
        };

        function initializeElementsJG() {
            elementsJG = {
                body: document.body,
                searchInput: document.getElementById('animal-tracker'),
                themeToggle: document.getElementById('weather-toggle'),
                profileButton: document.getElementById('profile-ranger'),
                mainAlbumArt: document.getElementById('main-album-art-jg'),
                songTitleDisplay: document.getElementById('song-title-jg'),
                artistNameDisplay: document.getElementById('artist-name-jg'),
                btnShuffle: document.getElementById('btn-shuffle-jg'),
                btnPrev: document.getElementById('btn-prev-jg'),
                btnPlay: document.getElementById('btn-play-jg'),
                btnNext: document.getElementById('btn-next-jg'),
                btnLoop: document.getElementById('btn-loop-jg'),
                currentTimeDisplay: document.getElementById('current-time-jg'),
                totalTimeDisplay: document.getElementById('total-time-jg'),
                progressSlider: document.getElementById('progress-slider-jg'),
                volumeSlider: document.getElementById('volume-slider-jg'),
                volumeIconMute: document.querySelector('.volume-fruit-jg .fa-volume-down'), // Updated icon class if changed
                // volumeIconUp: document.querySelector('.volume-fruit-jg .fa-volume-up'), // Removed if HTML simplified
                logTabs: document.querySelectorAll('.log-tab-jg'),
                logPanels: document.querySelectorAll('.log-panel-jg'),
                libraryPanel: document.getElementById('log-library'),
                queuePanel: document.getElementById('log-discoveries'),
                favoritesPanel: document.getElementById('log-trophies'),
                historyPanel: document.getElementById('log-history'),
                playlistsPanel: document.getElementById('log-paths'),
                queueCountBadge: document.getElementById('queue-count-jg'),
                btnRefreshFeed: document.getElementById('btn-refresh-feed-jg'),
                btnCreatePlaylist: document.getElementById('btn-create-playlist-jg'),
                youtubePlayerContainer: document.getElementById('youtube-player-container-jg'),
            };
            if (!elementsJG.youtubePlayerContainer) {
                let ytContainer = document.createElement('div');
                ytContainer.id = 'youtube-player-container-jg';
                Object.assign(ytContainer.style, { position: 'absolute', top: '-9999px', left: '-9999px', width: '1px', height: '1px' });
                document.body.appendChild(ytContainer);
                elementsJG.youtubePlayerContainer = ytContainer;
            }
            console.log("Jungle Groove Elements Initialized:", elementsJG);
        }

        const youtubeAPI_JG = {
            apiKey: 'AIzaSyCbzvjP9vFa5I8N1qLI5H9LUpYim0nkQS4', 
            channelId: 'UCYAuSEKhuk3v4ZKzm5Lqb1Q',
            async getLatestVideos(maxResults = 15) {
                if (!this.apiKey || this.apiKey.includes('YOUR_') || this.apiKey.includes('_PLACEHOLDER_')) {
                    showSnackbarJG("YouTube APIキーが設定されていません。", "error"); return [];
                }
                const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${this.channelId}&maxResults=${maxResults}&order=date&type=video&key=${this.apiKey}`;
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        const errorText = await response.text(); let errorData = null; try { errorData = JSON.parse(errorText); } catch (e) {}
                        throw new Error(errorData?.error?.message || `YouTube API error: ${response.status}`);
                    }
                    const data = await response.json();
                    if (!data.items) return [];
                    return data.items.map(item => ({
                        id: item.id.videoId, title: item.snippet.title, artist: item.snippet.channelTitle || "Rei Kikuchi",
                        thumbnail: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        duration: "--:--"
                    }));
                } catch (error) { showSnackbarJG(`曲の読み込みエラー: ${error.message}`, "error"); return []; }
            },
            async getVideoDetails(videoIds) { /* ... (same as before, ensure error handling) ... */ 
                if (!videoIds || videoIds.length === 0) return {};
                if (!this.apiKey || this.apiKey.includes('YOUR_') || this.apiKey.includes('_PLACEHOLDER_')) return {};
                const MAX_IDS_PER_REQUEST = 50; const details = {};
                for (let i = 0; i < videoIds.length; i += MAX_IDS_PER_REQUEST) {
                    const chunkIds = videoIds.slice(i, i + MAX_IDS_PER_REQUEST);
                    try {
                        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${chunkIds.join(',')}&key=${this.apiKey}`);
                        if (!response.ok) throw new Error(`YouTube Video Details API error: ${response.status}`);
                        const data = await response.json();
                        if (data.items) { data.items.forEach(item => { details[item.id] = item.contentDetails ? this.convertDuration(item.contentDetails.duration) : "--:--"; }); }
                    } catch (error) { console.error('Error fetching video details chunk:', error); }
                }
                return details;
            },
            convertDuration(isoDuration) { /* ... (same as before) ... */ 
                if (!isoDuration) return '--:--'; const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
                const matches = isoDuration.match(regex); if (!matches) return '--:--';
                const h = parseInt(matches[1] || 0); const m = parseInt(matches[2] || 0); const s = parseInt(matches[3] || 0);
                return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m}:${s.toString().padStart(2, '0')}`;
            }
        };

        async function loadInitialSongsJG() {
            if (!elementsJG.libraryPanel) return;
            showLoadingInPanelJG(elementsJG.libraryPanel, true);
            let songs = [];
            try { songs = await youtubeAPI_JG.getLatestVideos(25); } 
            catch (error) { /* ... (error handling) ... */ }

            if (songs && songs.length > 0) {
                const videoIds = songs.map(s => s.id).filter(id => id);
                if (videoIds.length > 0) {
                    try {
                        const durations = await youtubeAPI_JG.getVideoDetails(videoIds);
                        songs = songs.map(song => ({ ...song, duration: durations[song.id] || "--:--" }));
                    } catch (error) { /* ... (error handling) ... */ }
                }
            }
            appStateJG.songs = songs || [];
            appStateJG.filteredSongs = [...(songs || [])];
            if (elementsJG.libraryPanel) {
                renderSongListJG(elementsJG.libraryPanel, appStateJG.filteredSongs, 'library');
                showLoadingInPanelJG(elementsJG.libraryPanel, false);
                 if (!appStateJG.filteredSongs.length) {
                    const apiKey = youtubeAPI_JG.apiKey;
                    if (!apiKey || apiKey.includes('YOUR_') || apiKey.includes('_PLACEHOLDER_')) {
                         showEmptyMessageInPanelJG(elementsJG.libraryPanel, "APIキーが必要です", "曲をロードするにはAPIキーを設定してください。");
                    } else {
                        showEmptyMessageInPanelJG(elementsJG.libraryPanel, "まだ曲がありません", "新しい冒険が始まるのを待とう！");
                    }
                }
            }
            if (appStateJG.currentPanel === 'log-discoveries' && elementsJG.queuePanel) {
                 renderSongListJG(elementsJG.queuePanel, appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s), 'queue');
            }
        }
        
        function renderSongListJG(panelElement, songsToRender, context) {
            if (!panelElement) return;
            panelElement.innerHTML = '';
            if (!songsToRender || songsToRender.length === 0) {
                let title = "何も見つからない...", msg = "このエリアにはまだ何もないようだ。";
                if (context === 'library' && elementsJG.searchInput?.value) { title = "検索結果なし"; msg = `「${escapeHTMLJG(elementsJG.searchInput.value)}」に合う冒険は見つからなかった...`; }
                else if (context === 'queue') { title = "キューは空っぽ"; msg = "次の冒険の準備をしよう！"; }
                else if (context === 'favorites') { title = "お気に入りの宝物なし"; msg = "まだお気に入りの発見がないようだ。曲の星アイコンをクリック！"; }
                else if (context === 'history') { title = "足跡なし"; msg = "まだどの曲も探検していないようだ。"; }
                showEmptyMessageInPanelJG(panelElement, title, msg); return;
            }
            const fragment = document.createDocumentFragment();
            songsToRender.forEach(song => {
                if (!song || !song.id) return;
                const originalSongIndex = appStateJG.songs.findIndex(s => s.id === song.id);
                const currentPlayingSong = appStateJG.songs[appStateJG.currentSongIndex];
                const isActive = currentPlayingSong && currentPlayingSong.id === song.id;
                const isFavorited = appStateJG.favorites.some(fav => fav.id === song.id);
                const entry = document.createElement('div');
                entry.className = `log-entry-jg ${isActive ? 'active-song' : ''}`;
                entry.dataset.id = song.id; entry.dataset.originalIndex = originalSongIndex;
                entry.innerHTML = `
                    <img src="${song.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}"
                         alt="${escapeHTMLJG(song.title || '')}" class="${!song.thumbnail ? 'img-placeholder list-thumb-placeholder' : ''}">
                    <div><span class="title">${escapeHTMLJG(song.title || '不明なタイトル')}</span><span class="artist">${escapeHTMLJG(song.artist || 'Rei Kikuchi')}</span></div>
                    <span class="duration">${song.duration || '--:--'}</span>
                    <button class="song-item-action-jg" aria-label="${isFavorited ? 'お気に入りから削除' : 'お気に入りに追加'}">
                        <i class="fas fa-star ${isFavorited ? '' : 'far'}"></i> <!-- Use fas for favorited, far for not -->
                    </button>`;
                entry.addEventListener('click', (e) => {
                    const clickedButton = e.target.closest('.song-item-action-jg');
                    if (clickedButton) { toggleFavoriteJG(song.id, clickedButton.querySelector('i')); } 
                    else { const idx = parseInt(entry.dataset.originalIndex, 10); if (!isNaN(idx) && idx !== -1) playSongAtIndexJG(idx); }
                });
                fragment.appendChild(entry);
            });
            panelElement.appendChild(fragment);
        }

        function showLoadingInPanelJG(panel, isLoading) { if(panel) panel.innerHTML = isLoading ? `<div class="flex justify-center items-center h-full text-jg-text-shadow"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="ml-2">探検中...</p></div>` : ''; }
        function showEmptyMessageInPanelJG(panel, title, msg) { if(panel) panel.innerHTML = `<div class="text-center p-8 text-jg-text-shadow"><i class="fas fa-compass fa-3x mb-4 opacity-50"></i><h4 class="font-display-jg text-xl text-jg-text-earth mb-2">${escapeHTMLJG(title)}</h4><p class="text-sm">${escapeHTMLJG(msg)}</p></div>`; }

        function updatePlayerUIGJ(song) {
            const playerEl = document.querySelector('.watering-hole-player');
            if (song) {
                elementsJG.mainAlbumArt.src = song.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                elementsJG.mainAlbumArt.classList.toggle('album-art-placeholder', !song.thumbnail);
                if (!song.thumbnail && elementsJG.mainAlbumArt.classList.contains('album-art-placeholder')) {
                    elementsJG.mainAlbumArt.innerHTML = '<i class="fas fa-music"></i>'; 
                } else {
                    elementsJG.mainAlbumArt.innerHTML = '';
                }
                elementsJG.songTitleDisplay.textContent = song.title || "Wild Rhythms";
                elementsJG.artistNameDisplay.textContent = song.artist || "The Jungle Cats";
                playerEl?.classList.add('has-song');
            } else {
                elementsJG.mainAlbumArt.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                elementsJG.mainAlbumArt.classList.add('album-art-placeholder');
                elementsJG.mainAlbumArt.innerHTML = '<i class="fas fa-music"></i>';
                elementsJG.songTitleDisplay.textContent = "Wild Rhythms";
                elementsJG.artistNameDisplay.textContent = "The Jungle Cats";
                elementsJG.currentTimeDisplay.textContent = "0:00";
                elementsJG.totalTimeDisplay.textContent = "0:00";
                elementsJG.progressSlider.value = 0;
                playerEl?.classList.remove('has-song');
            }
            updatePlayPauseButtonJG();
            updateActiveListItemJG();
        }

        function updatePlayPauseButtonJG() {
            if (!elementsJG.btnPlay) return;
            const iconClass = appStateJG.isPlaying ? 'fa-pause' : 'fa-play';
            elementsJG.btnPlay.innerHTML = `<i class="fas ${iconClass}"></i>`;
            document.querySelector('.watering-hole-player')?.classList.toggle('is-playing', appStateJG.isPlaying);
        }

        function updateActiveListItemJG() {
            document.querySelectorAll('.log-entry-jg.active-song').forEach(el => el.classList.remove('active-song'));
            if (appStateJG.currentSongIndex !== -1 && appStateJG.songs && appStateJG.currentSongIndex < appStateJG.songs.length) {
                const currentSongId = appStateJG.songs[appStateJG.currentSongIndex]?.id;
                if (currentSongId) {
                    document.querySelectorAll(`.log-entry-jg[data-id="${currentSongId}"]`).forEach(item => item.classList.add('active-song'));
                }
            }
        }
        
        function playSongAtIndexJG(index) { /* ... (same as before, ensure logging) ... */
            if (index < 0 || !appStateJG.songs || index >= appStateJG.songs.length) return;
            appStateJG.currentSongIndex = index; const song = appStateJG.songs[index]; if (!song) return;
            console.log("Playing song:", song.title, "ID:", song.id); updatePlayerUIGJ(song);
            if (appStateJG.player && appStateJG.isPlayerReady && song.id) { try { appStateJG.player.loadVideoById(song.id); } catch (e) { showSnackbarJG("動画の読み込みに失敗。", "error");} }
            else if(!appStateJG.isPlayerReady) { showSnackbarJG("プレイヤー準備中。", "warning");}
            addToHistoryJG(song); if (appStateJG.currentPanel === 'log-history' && elementsJG.historyPanel) renderHistoryListJG();
            appStateJG.playMode = 'library'; // Reset play mode unless specifically playing from queue
        }

        function togglePlayPauseJG() { /* ... (same as before, ensure checks) ... */
            if (!appStateJG.player || !appStateJG.isPlayerReady) { showSnackbarJG("プレイヤー準備中。", "warning"); return; }
            if (appStateJG.currentSongIndex === -1 && appStateJG.songs?.length > 0) { playSongAtIndexJG(0); return; }
            if (appStateJG.currentSongIndex === -1 && (!appStateJG.songs || appStateJG.songs.length === 0)) { showSnackbarJG("再生曲なし。", "info"); return; }
            appStateJG.isPlaying ? appStateJG.player.pauseVideo() : appStateJG.player.playVideo();
        }
        
        // PlayNextJG, PlayPrevJG, HandleSongEndJG, UpdateProgressJG - these complex functions should be mostly the same logic as before
        // Ensure they handle appStateJG.playMode === 'queue' correctly.
        function playNextJG() {
            if (!appStateJG.songs || appStateJG.songs.length === 0) return;
            let nextIndex;

            if (appStateJG.playMode === 'queue' && appStateJG.queue.length > 0) {
                appStateJG.currentQueueIndex++;
                if (appStateJG.currentQueueIndex < appStateJG.queue.length) {
                    const nextSongIdInQueue = appStateJG.queue[appStateJG.currentQueueIndex];
                    nextIndex = appStateJG.songs.findIndex(s => s.id === nextSongIdInQueue);
                    if (nextIndex === -1) return playNextGeneralLogic();
                } else { 
                    if (appStateJG.loopMode === 'all' || appStateJG.loopMode === 'one') { 
                        appStateJG.currentQueueIndex = 0;
                        const nextSongIdInQueue = appStateJG.queue[appStateJG.currentQueueIndex];
                        nextIndex = appStateJG.songs.findIndex(s => s.id === nextSongIdInQueue);
                        if (nextIndex === -1) return playNextGeneralLogic();
                    } else {
                        showSnackbarJG("キュー再生終了。", "info"); appStateJG.isPlaying = false; updatePlayPauseButtonJG(); return;
                    }
                }
            } else {
                nextIndex = playNextGeneralLogic(true); 
                if (nextIndex === -1) return; 
            }
            playSongAtIndexJG(nextIndex);
        }

        function playNextGeneralLogic(canStop = false) {
            let nextIdx = appStateJG.currentSongIndex;
            if (appStateJG.isShuffle) {
                if (appStateJG.songs.length <= 1) nextIdx = 0;
                else do { nextIdx = Math.floor(Math.random() * appStateJG.songs.length); } while (nextIdx === appStateJG.currentSongIndex && appStateJG.songs.length > 1);
            } else {
                nextIdx = (appStateJG.currentSongIndex + 1);
                if (nextIdx >= appStateJG.songs.length) {
                    if (appStateJG.loopMode === 'all') nextIdx = 0;
                    else if (canStop) { showSnackbarJG("探検終了！", "info"); appStateJG.isPlaying = false; updatePlayPauseButtonJG(); return -1; }
                    else { nextIdx = 0; }
                }
            }
            return nextIdx;
        }

        function playPrevJG() {
            if (!appStateJG.songs || appStateJG.songs.length === 0) return;
            if (appStateJG.playMode === 'queue' && appStateJG.queue.length > 0 && appStateJG.currentQueueIndex > 0) {
                 appStateJG.currentQueueIndex--; const prevSongId = appStateJG.queue[appStateJG.currentQueueIndex];
                 const originalIndex = appStateJG.songs.findIndex(s => s.id === prevSongId);
                 if (originalIndex !== -1) { playSongAtIndexJG(originalIndex); return; }
            }
            if (appStateJG.player?.getCurrentTime && appStateJG.player.getCurrentTime() > 3) { appStateJG.player.seekTo(0); return; }
            let prevIdx;
            if (appStateJG.isShuffle) {
                if (appStateJG.songs.length <= 1) prevIdx = 0;
                else do { prevIdx = Math.floor(Math.random() * appStateJG.songs.length); } while (prevIdx === appStateJG.currentSongIndex && appStateJG.songs.length > 1);
            } else { prevIdx = (appStateJG.currentSongIndex - 1 + appStateJG.songs.length) % appStateJG.songs.length; }
            playSongAtIndexJG(prevIdx);
        }

        function handleSongEndJG() { (appStateJG.loopMode === 'one') ? playSongAtIndexJG(appStateJG.currentSongIndex) : playNextJG(); }

        function updateProgressJG() {
            if (!appStateJG.player || typeof appStateJG.player.getDuration !== 'function' || !elementsJG.progressSlider) return;
            const currentTime = appStateJG.player.getCurrentTime ? appStateJG.player.getCurrentTime() : 0;
            const duration = appStateJG.player.getDuration ? appStateJG.player.getDuration() : 0;
            if (elementsJG.progressSlider && elementsJG.currentTimeDisplay && elementsJG.totalTimeDisplay) {
                if (duration > 0) {
                    elementsJG.progressSlider.value = (currentTime / duration) * 100;
                    elementsJG.currentTimeDisplay.textContent = formatTimeJG(currentTime);
                    elementsJG.totalTimeDisplay.textContent = formatTimeJG(duration);
                    const currentSong = appStateJG.songs[appStateJG.currentSongIndex];
                    if (currentSong && currentSong.duration === "--:--") {
                        currentSong.duration = formatTimeJG(duration);
                        document.querySelectorAll(`.log-entry-jg[data-id="${currentSong.id}"] .duration`).forEach(el => el.textContent = currentSong.duration);
                    }
                } else { elementsJG.progressSlider.value = 0; elementsJG.currentTimeDisplay.textContent = "0:00"; }
            }
        }
        
        function onPlayerReadyJG(event) { /* ... (same as before, ensure API key check and loadInitialSongsJG) ... */
            console.log("Player Ready (onPlayerReadyJG). Player:", !!event.target); appStateJG.isPlayerReady = true;
            if (event.target?.setVolume) { try { event.target.setVolume(appStateJG.volume); } catch(e){ console.warn("Could not set volume on ready", e); } }
            const apiKey = youtubeAPI_JG.apiKey;
            if (apiKey && !apiKey.includes('YOUR_') && !apiKey.includes('_PLACEHOLDER_') && apiKey.length > 10) { loadInitialSongsJG(); }
            else { showSnackbarJG("APIキー未設定。曲をロードできません。", "error"); if (elementsJG.libraryPanel) showEmptyMessageInPanelJG(elementsJG.libraryPanel, "APIキー未設定", "APIキーを設定してください。");}
        }
        function onPlayerStateChangeJG(event) { /* ... (same as before, handle all states) ... */
            const playerState = event.data; const previouslyPlaying = appStateJG.isPlaying;
            appStateJG.isPlaying = (playerState === YT.PlayerState.PLAYING);
            if (previouslyPlaying !== appStateJG.isPlaying) updatePlayPauseButtonJG();
            if (appStateJG.isPlaying) { if (appStateJG.progressInterval) clearInterval(appStateJG.progressInterval); appStateJG.progressInterval = setInterval(updateProgressJG, 250); updateProgressJG(); }
            else { clearInterval(appStateJG.progressInterval); if (playerState !== YT.PlayerState.BUFFERING) updateProgressJG(); } // Update unless just buffering
            if (playerState === YT.PlayerState.ENDED) handleSongEndJG();
            if (playerState === YT.PlayerState.PLAYING) updateActiveListItemJG();
        }
        function onPlayerErrorJG(event) { /* ... (same as before, with error codes) ... */
            console.error("Player Error:", event.data, "for song:", appStateJG.songs[appStateJG.currentSongIndex]?.id);
            let msg = `再生エラー (コード: ${event.data})`;
            if (event.data === 2) msg = "無効な動画ID/リクエスト。"; if (event.data === 5) msg = "HTML5プレイヤーエラー。";
            if (event.data === 100) msg = "動画が見つかりません。"; if (event.data === 101 || event.data === 150) msg = "埋め込み再生が許可されていません。";
            showSnackbarJG(msg, "error"); appStateJG.isPlaying = false; updatePlayPauseButtonJG();
        }

        function setupEventListenersJG() { /* ... (same as before, ensure all elements exist) ... */
            elementsJG.btnPlay?.addEventListener('click', togglePlayPauseJG);
            elementsJG.btnNext?.addEventListener('click', playNextJG);
            elementsJG.btnPrev?.addEventListener('click', playPrevJG);
            elementsJG.btnShuffle?.addEventListener('click', toggleShuffleJG);
            elementsJG.btnLoop?.addEventListener('click', toggleLoopJG);
            elementsJG.progressSlider?.addEventListener('input', e => {
                if (!appStateJG.player?.getDuration) return; const duration = appStateJG.player.getDuration();
                if (duration > 0) { appStateJG.player.seekTo((parseFloat(e.target.value) / 100) * duration, true); updateProgressJG(); }
            });
            elementsJG.volumeSlider?.addEventListener('input', e => {
                appStateJG.volume = parseInt(e.target.value); if (appStateJG.player?.setVolume) appStateJG.player.setVolume(appStateJG.volume);
                if (elementsJG.volumeIconMute) { elementsJG.volumeIconMute.style.opacity = appStateJG.volume === 0 ? '1' : '0.7';}
                // Update other volume icon if it exists (e.g., elementsJG.volumeIconUp)
            });
            elementsJG.themeToggle?.addEventListener('click', toggleThemeJG);
            elementsJG.logTabs.forEach(tab => tab.addEventListener('click', () => switchLogPanelJG(tab.dataset.panel)));
            elementsJG.searchInput?.addEventListener('input', handleSearchJG);
            elementsJG.btnRefreshFeed?.addEventListener('click', () => { showSnackbarJG("フィード更新中...", "info"); loadInitialSongsJG(); });
            elementsJG.btnCreatePlaylist?.addEventListener('click', () => showSnackbarJG("プレイリスト作成は未実装です。", "info"));
        }

        function toggleThemeJG() { /* ... (same as before) ... */
            if (!elementsJG.body || !elementsJG.themeToggle) return;
            elementsJG.body.classList.toggle('light-mode-jg');
            appStateJG.currentTheme = elementsJG.body.classList.contains('light-mode-jg') ? 'light' : 'dark';
            elementsJG.themeToggle.innerHTML = `<i class="fas ${appStateJG.currentTheme === 'light' ? 'fa-moon' : 'fa-lightbulb'}"></i>`; // Matched icon
            saveToLocalStorageJG(LS_KEYS_JG.THEME, appStateJG.currentTheme);
            showSnackbarJG(`テーマ変更: ${appStateJG.currentTheme === 'light' ? 'ライト' : 'ダーク'}`);
        }
        function switchLogPanelJG(panelId) { /* ... (same as before, with all panels) ... */
            if (!panelId || appStateJG.currentPanel === panelId) return; appStateJG.currentPanel = panelId;
            elementsJG.logTabs.forEach(t => t.classList.toggle('active', t.dataset.panel === panelId));
            elementsJG.logPanels.forEach(p => p?.classList.toggle('active', p.id === panelId));
            switch (panelId) {
                case 'log-library': if (elementsJG.libraryPanel) renderSongListJG(elementsJG.libraryPanel, appStateJG.filteredSongs, 'library'); break;
                case 'log-discoveries': if (elementsJG.queuePanel) renderSongListJG(elementsJG.queuePanel, appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s), 'queue'); break;
                case 'log-trophies': if (elementsJG.favoritesPanel) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites'); break;
                case 'log-history': if(elementsJG.historyPanel) renderHistoryListJG(); break;
                case 'log-paths': if(elementsJG.playlistsPanel) showEmptyMessageInPanelJG(elementsJG.playlistsPanel, "プレイリストなし", "新しい音楽の道を作ろう！"); break;
            }
        }
        function handleSearchJG() { /* ... (same as before) ... */
            if (!elementsJG.searchInput) return; const term = elementsJG.searchInput.value.toLowerCase().trim();
            appStateJG.filteredSongs = term === "" ? [...appStateJG.songs] : appStateJG.songs.filter(s => (s.title && s.title.toLowerCase().includes(term)) || (s.artist && s.artist.toLowerCase().includes(term)));
            if (appStateJG.currentPanel === 'log-library' && elementsJG.libraryPanel) renderSongListJG(elementsJG.libraryPanel, appStateJG.filteredSongs, 'library');
        }
        function toggleShuffleJG() { /* ... (same as before) ... */
             if (!elementsJG.btnShuffle) return; appStateJG.isShuffle = !appStateJG.isShuffle;
             elementsJG.btnShuffle.classList.toggle('active-control', appStateJG.isShuffle);
             showSnackbarJG(`シャッフル ${appStateJG.isShuffle ? 'ON' : 'OFF'}`);
        }
        function toggleLoopJG() { /* ... (same as before, check loop indicator element creation) ... */
            if (!elementsJG.btnLoop) return;
            if (appStateJG.loopMode === 'none') appStateJG.loopMode = 'all'; else if (appStateJG.loopMode === 'all') appStateJG.loopMode = 'one'; else appStateJG.loopMode = 'none';
            elementsJG.btnLoop.classList.toggle('active-control', appStateJG.loopMode !== 'none');
            let indicator = elementsJG.btnLoop.querySelector('.loop-indicator-jg');
            if (appStateJG.loopMode === 'one') {
                if (!indicator) { indicator = document.createElement('span'); indicator.className = 'loop-indicator-jg'; elementsJG.btnLoop.appendChild(indicator); }
                indicator.textContent = '1';
            } else { if (indicator) indicator.remove(); }
            let msg = "リピート: "; if(appStateJG.loopMode === 'none') msg += "OFF"; if(appStateJG.loopMode === 'all') msg += "全曲"; if(appStateJG.loopMode === 'one') msg += "1曲";
            showSnackbarJG(msg);
        }

        function addToHistoryJG(song) { /* ... (same as before) ... */
            if (!song || !song.id) return; appStateJG.history = appStateJG.history.filter(s => s.id !== song.id);
            appStateJG.history.unshift(song); if (appStateJG.history.length > MAX_HISTORY_JG) appStateJG.history.pop();
            saveToLocalStorageJG(LS_KEYS_JG.HISTORY, appStateJG.history);
        }
        function renderHistoryListJG() { if (elementsJG.historyPanel) renderSongListJG(elementsJG.historyPanel, appStateJG.history, 'history'); }

        function toggleFavoriteJG(songId, iconElement) { /* ... (ensure correct icon class toggling: fas/far for fa-star) ... */
            const songIdxFav = appStateJG.favorites.findIndex(s => s.id === songId); const song = findSongByIdJG(songId); if (!song) return;
            let isNowFav = false;
            if (songIdxFav > -1) { appStateJG.favorites.splice(songIdxFav, 1); showSnackbarJG(`「${escapeHTMLJG(song.title)}」をお気に入り解除`); }
            else { appStateJG.favorites.push(song); isNowFav = true; showSnackbarJG(`「${escapeHTMLJG(song.title)}」をお気に入り登録`, "success"); }
            if (iconElement) { iconElement.className = `fas fa-star ${isNowFav ? '' : 'far'}`; iconElement.closest('button').setAttribute('aria-label', isNowFav ? 'お気に入りから削除' : 'お気に入りに追加'); }
            saveToLocalStorageJG(LS_KEYS_JG.FAVORITES, appStateJG.favorites);
            if (appStateJG.currentPanel === 'log-trophies' && elementsJG.favoritesPanel) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites');
            document.querySelectorAll(`.log-entry-jg[data-id="${songId}"] .song-item-action-jg i`).forEach(icon => { icon.className = `fas fa-star ${isNowFav ? '' : 'far'}`; icon.closest('button').setAttribute('aria-label', isNowFav ? 'お気に入りから削除' : 'お気に入りに追加'); });
        }

        function updateQueueCountBadgeJG() { /* ... (same as before) ... */
             if (elementsJG.queueCountBadge) { elementsJG.queueCountBadge.textContent = appStateJG.queue.length; elementsJG.queueCountBadge.style.display = appStateJG.queue.length > 0 ? 'inline-block' : 'none'; }
        }
        function findSongByIdJG(id) {
            return appStateJG.songs?.find(s => s?.id === id) || null;
        }

        function formatTimeJG(s) {
            if (isNaN(s) || s < 0) return "0:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }

        function escapeHTMLJG(str) {
            if (typeof str !== 'string' || !str) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        function saveToLocalStorageJG(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("localStorage save error:", e);
                showSnackbarJG("設定保存失敗。", "error");
            }
        }

        function loadFromLocalStorageJG(key) {
            try {
                const d = localStorage.getItem(key);
                return d ? JSON.parse(d) : null;
            } catch (e) {
                console.error("localStorage load error:", e);
                return null;
            }
        }

        function showSnackbarJG(message, type = 'info', duration = 3000) {
            const snackbarId = 'snackbar-jg-dynamic'; let snackbar = document.getElementById(snackbarId);
            if (!snackbar) { snackbar = document.createElement('div'); snackbar.id = snackbarId;
                // Basic styles here, detailed styling in CSS if a class is added
                Object.assign(snackbar.style, { position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%) translateY(100px)', padding: '12px 25px', borderRadius: 'var(--border-radius-medium)', boxShadow: '0 4px 15px var(--jg-shadow-heavy)', zIndex: '10001', opacity: '0', transition: 'opacity 0.3s ease, transform 0.3s ease-out', fontSize: '0.9rem', fontFamily: 'var(--font-body-jg, sans-serif)', textAlign: 'center', minWidth: '280px', maxWidth: '90%' });
                document.body.appendChild(snackbar);
            }
            snackbar.textContent = message;
            let bgColorVar = 'var(--jg-surface-bark)'; // Default (info)
            let textColorVar = 'var(--jg-text-light)';
            if (type === 'error') { bgColorVar = 'var(--jg-accent-sunburst)'; textColorVar = 'var(--jg-bg-deep-jungle)'; } // Example: using sunburst for error
            else if (type === 'success') { bgColorVar = 'var(--jg-accent-canopy)'; textColorVar = 'var(--jg-bg-deep-jungle)';}
            else if (type === 'warning') { bgColorVar = 'var(--jg-accent-sunburst)'; textColorVar = 'var(--jg-bg-deep-jungle)'; } // Could use a different accent
            snackbar.style.backgroundColor = bgColorVar;
            snackbar.style.color = textColorVar;

            requestAnimationFrame(() => { snackbar.style.opacity = '1'; snackbar.style.transform = 'translateX(-50%) translateY(0)'; });
            if (appStateJG.snackbarTimeoutId) clearTimeout(appStateJG.snackbarTimeoutId);
            appStateJG.snackbarTimeoutId = setTimeout(() => { snackbar.style.opacity = '0'; snackbar.style.transform = 'translateX(-50%) translateY(100px)'; }, duration);
        }

        function loadInitialDataJG() { /* ... (same as before, ensure theme toggle updates icon correctly) ... */
            appStateJG.history = loadFromLocalStorageJG(LS_KEYS_JG.HISTORY) || [];
            appStateJG.favorites = loadFromLocalStorageJG(LS_KEYS_JG.FAVORITES) || [];
            appStateJG.queue = loadFromLocalStorageJG(LS_KEYS_JG.QUEUE) || [];
            appStateJG.currentTheme = loadFromLocalStorageJG(LS_KEYS_JG.THEME) || 'dark';
            if (elementsJG.body && elementsJG.themeToggle) {
                if (appStateJG.currentTheme === 'light') { elementsJG.body.classList.add('light-mode-jg'); elementsJG.themeToggle.innerHTML = `<i class="fas fa-moon"></i>`; }
                else { elementsJG.body.classList.remove('light-mode-jg'); elementsJG.themeToggle.innerHTML = `<i class="fas fa-lightbulb"></i>`; } // Matched icon
            }
            if (elementsJG.favoritesPanel) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites');
            if (elementsJG.historyPanel) renderHistoryListJG();
            if (elementsJG.queuePanel) { const qSongs = appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s); renderSongListJG(elementsJG.queuePanel, qSongs, 'queue');}
            updateQueueCountBadgeJG();
            if(elementsJG.volumeSlider) elementsJG.volumeSlider.value = appStateJG.volume;
            if (elementsJG.volumeIconMute) { elementsJG.volumeIconMute.style.opacity = appStateJG.volume === 0 ? '1' : '0.7'; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded - START. Initializing Jungle Groove...");
            initializeElementsJG(); loadInitialDataJG(); setupEventListenersJG();
            updatePlayerUIGJ(null); // Initial UI state
            if (elementsJG.btnShuffle) elementsJG.btnShuffle.classList.toggle('active-control', appStateJG.isShuffle);
            if (elementsJG.btnLoop) {
                elementsJG.btnLoop.classList.toggle('active-control', appStateJG.loopMode !== 'none');
                let indicator = elementsJG.btnLoop.querySelector('.loop-indicator-jg');
                if (appStateJG.loopMode === 'one') {
                    if (!indicator) { indicator = document.createElement('span'); indicator.className = 'loop-indicator-jg'; elementsJG.btnLoop.appendChild(indicator); }
                    indicator.textContent = '1';
                } else if (indicator) { indicator.remove(); }
            }
            console.log("DOMContentLoaded - END. UI initialized. Waiting for YouTube API.");
        });
    </script>
</body>
</html>
