<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jungle Groove - Wild Music Safari</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* jungle_groove_styles.css */
        :root {
            /* Default Dark Jungle (Restored & Adjusted for Contrast) */
            --jg-bg-deep-jungle: #122c2c; 
            --jg-bg-forest-floor: #3a2e27; 
            --jg-surface-bark: #6a4c3a;   
            --jg-surface-leaf: #4a703b;   
            --jg-accent-sunburst: #FFB743; 
            --jg-accent-canopy: #66BB6A;   
            --jg-accent-waterfall: #4FC3F7; 
            --jg-text-light: #F5F5F5;      
            --jg-text-earth: #E0CDB4;      
            --jg-text-shadow: #B0A08C;     
            --jg-border-vine: #5D4037;   
            --jg-shadow-heavy: rgba(0,0,0,0.5); 
            --jg-shadow-light: rgba(0,0,0,0.25);

            --font-display-jg: 'Kalam', cursive;
            --font-body-jg: 'Montserrat', sans-serif;

            --jg-surface-bark-rgb: 106, 76, 58;
            --jg-surface-leaf-rgb: 74, 112, 59;
            --jg-bg-forest-floor-rgb: 58, 46, 39;
            --jg-accent-canopy-rgb: 102, 187, 106;
            --jg-accent-sunburst-rgb: 255, 183, 67;

            --jg-placeholder-bg: var(--jg-surface-bark);
        }
        html {
            height: 100%; /* Ensure html takes full height for 100vh body */
        }
        body { /* Generic body, theme classes will override */
            font-family: var(--font-body-jg);
            background-color: var(--jg-bg-deep-jungle);
            color: var(--jg-text-light);
            margin: 0;
            height: 100%; /* Changed from 100vh to work better with full-height app-safari-hut */
            overflow: hidden; /* Keep this to prevent body scrollbars */
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }

        .jungle-background-layers { position: fixed; inset: 0; z-index: -1; }
        .jungle-background-layers .layer {
            position: absolute; inset: 0;
            transition: transform 0.5s ease-out, opacity 0.5s ease;
        }
        .layer-1 { background: linear-gradient(to bottom, #3A506B, #1C2541 70%); opacity: 0.8; }
        .layer-2 { background-color: rgba(var(--jg-surface-leaf-rgb), 0.15); opacity: 0.4; transform: scale(1.05); }
        .layer-3 { opacity: 0.6; transform: scale(1.1); }

        .app-safari-hut {
            /* Mobile-first styles */
            width: 100%; 
            height: 100%; /* Full height of the body */
            margin: 0;
            background-color: rgba(40, 30, 20, 0.65); /* Fallback, theme will override */
            backdrop-filter: blur(15px) saturate(120%);
            -webkit-backdrop-filter: blur(15px) saturate(120%);
            border: none; 
            border-radius: 0; 
            box-shadow: none; 
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Apply desktop styles using md breakpoint (768px) */
        @media (min-width: 768px) {
            .app-safari-hut {
                width: 95vw; height: 90vh; max-width: 1500px; max-height: 850px;
                margin: 2.5vh auto;
                border-width: 3px;
                border-style: solid;
                border-color: var(--jg-border-vine); /* Default, themes will override this var or specific rule */
                border-radius: 25px;
                box-shadow: 0 10px 40px var(--jg-shadow-heavy);
            }
            /* Theme-specific border/shadow overrides for desktop */
            body.theme-dark-jg .app-safari-hut { border-color: var(--jg-border-vine); } /* Already default */
            body.theme-light-jg .app-safari-hut { border-color: var(--jg-border-vine); }
            body.theme-ocean-breeze-jg .app-safari-hut { border-color: var(--jg-border-vine); }
            body.theme-forest-dawn-jg .app-safari-hut { border-color: var(--jg-border-vine); }
            body.theme-neon-noir-jg .app-safari-hut {
                border: 3px solid var(--jg-accent-canopy);
                box-shadow: 0 0 25px rgba(var(--jg-accent-canopy-rgb), 0.5), 0 0 40px rgba(var(--jg-accent-sunburst-rgb), 0.3);
            }
        }


        .safari-map-bar {
            display: flex; /* Will be overridden by Tailwind for responsiveness */
            align-items: center; 
            justify-content: space-between;
            padding: 1rem 1.5rem; /* Will be overridden by Tailwind for responsiveness */
            background-color: rgba(var(--jg-surface-bark-rgb), 0.85);
            border-bottom: 2px solid var(--jg-border-vine);
            box-shadow: 0 4px 10px var(--jg-shadow-light);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .compass-logo { font-family: var(--font-display-jg); font-size: 1.6rem; font-weight: 700; color: var(--jg-text-light); }
        .compass-logo i { color: var(--jg-accent-sunburst); margin-right: 0.5rem; transform: rotate(-15deg); }
        .text-accent-jg { color: var(--jg-accent-canopy); }

        .search-outpost {
            display: flex; align-items: center;
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.75);
            padding: 0.5rem 1rem; border-radius: 30px;
            border: 1px solid var(--jg-border-vine);
            position: relative; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        .search-outpost i.fa-binoculars { color: var(--jg-text-shadow); margin-right: 0.7rem; }
        #animal-tracker {
            background: transparent; border: none; outline: none;
            color: var(--jg-text-light); font-size: 0.9rem; width: 250px; /* md:w-[250px] in HTML */
            padding-right: 25px; 
        }
        #animal-tracker::placeholder { color: var(--jg-text-shadow); opacity: 0.8; }
        #clear-search-btn-jg {
            position: absolute; right: 0.8rem; top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: var(--jg-text-shadow);
            cursor: pointer; font-size: 1rem; padding: 0.2rem; line-height: 1;
        }
        #clear-search-btn-jg:hover { color: var(--jg-text-light); }


        .safari-tools { display: flex; align-items: center; gap: 0.75rem; }
        .tool-btn-jg {
            background-color: var(--jg-surface-bark); border: 1px solid var(--jg-border-vine);
            color: var(--jg-text-earth); width: 40px; height: 40px;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: all 0.2s ease;
            box-shadow: 0 2px 5px var(--jg-shadow-light);
        }
        .tool-btn-jg:hover {
            background-color: var(--jg-accent-sunburst); color: var(--jg-bg-deep-jungle);
            transform: scale(1.1);
        }
        .tool-btn-jg.profile .profile-avatar-placeholder {
            width: 30px; height: 30px; border-radius: 50%;
            background-color: var(--jg-text-shadow); 
        }

        .safari-zone { flex-grow: 1; display: flex; /* overridden by Tailwind */ padding: 1.5rem; gap: 1.5rem; /* overridden by Tailwind */ overflow: hidden; }

        .watering-hole-player {
            /* flex: 3; overridden by Tailwind */
            background: linear-gradient(135deg, rgba(var(--jg-surface-leaf-rgb),0.7), rgba(var(--jg-surface-bark-rgb),0.5));
            border-radius: 20px; padding: 2rem; /* overridden by Tailwind */
            display: flex; flex-direction: column; align-items: center;
            box-shadow: inset 0 0 15px var(--jg-shadow-light);
            border: 2px solid var(--jg-border-vine);
            transition: background 0.3s, border-color 0.3s;
        }
        .album-canopy {
            width: 280px; height: 280px; /* overridden by Tailwind */ border-radius: 15px; margin-bottom: 1.5rem; /* overridden by Tailwind */
            position: relative; box-shadow: 0 8px 25px var(--jg-shadow-heavy);
            overflow: hidden; background-color: var(--jg-bg-forest-floor);
            transition: background-color 0.3s;
        }
        #main-album-art-jg.album-art-placeholder {
            width: 100%; height: 100%; border: 4px solid var(--jg-surface-bark);
            background-color: var(--jg-text-shadow);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: var(--jg-bg-deep-jungle);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        .leaf-overlay { position: absolute; inset: 0; opacity: 0.1; pointer-events: none; }
        .track-details-jg { text-align: center; margin-bottom: 1.5rem; /* overridden by Tailwind */ }
        #song-title-jg { font-family: var(--font-display-jg); font-size: 2.5rem; /* overridden by Tailwind */ font-weight: 700; color: var(--jg-text-light); margin-bottom: 0.25rem; min-height: 1.2em; }
        #artist-name-jg { font-size: 1.1rem; /* overridden by Tailwind */ color: var(--jg-text-earth); min-height: 1.2em; }

        .player-controls-jg { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; /* overridden by Tailwind */ }
        .control-rock {
            background-color: var(--jg-surface-bark); border: 2px solid #5C4033; /* Default dark border */
            color: var(--jg-text-earth); border-radius: 50%;
            width: 60px; height: 60px; font-size: 1.2rem;
            display: inline-flex; align-items: center; justify-content: center;
            box-shadow: 2px 2px 5px var(--jg-shadow-light), inset 1px 1px 3px rgba(255,255,255,0.1);
            transition: all 0.15s ease-out;
            text-shadow: 1px 1px 2px var(--jg-shadow-heavy);
        }
        .control-rock:hover { transform: translateY(-2px) scale(1.05); box-shadow: 4px 4px 8px var(--jg-shadow-light), inset 1px 1px 3px rgba(255,255,255,0.1); }
        .control-rock:active { transform: translateY(1px) scale(0.98); box-shadow: 1px 1px 3px var(--jg-shadow-light), inset 1px 1px 3px rgba(0,0,0,0.2); }
        .control-rock.small { width: 45px; height: 45px; font-size: 1rem; }
        .control-rock.play {
            width: 75px; height: 75px; font-size: 2rem;
            background-color: var(--jg-accent-canopy);
            border-color: var(--jg-accent-canopy);
            color: var(--jg-text-light); /* Usually light text on canopy color */
        }
        #btn-playback-rate-jg {
            width: 55px; height: 40px; font-size: 0.9rem; border-radius: 20px;
            padding: 0 0.5rem;
        }
        #btn-playback-rate-jg.active-control, .control-rock.active-control { 
            color: var(--jg-accent-sunburst) !important;
            border-color: var(--jg-accent-sunburst) !important;
            box-shadow: 0 0 10px var(--jg-accent-sunburst), inset 1px 1px 3px rgba(255,255,255,0.1);
        }


        .progress-liana-jg { display: flex; align-items: center; gap: 0.75rem; width: 100%; max-width: 400px; /* overridden by Tailwind */ margin-bottom: 1rem; /* overridden by Tailwind */ }
        .progress-liana-jg span { font-size: 0.8rem; color: var(--jg-text-shadow); }
        .liana-slider {
            -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px;
            background-color: var(--jg-border-vine);
            border-radius: 4px; cursor: pointer;
            transition: background-color 0.3s;
        }
        .liana-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background-color: var(--jg-accent-canopy);
            background-size: contain; border: none; border-radius: 50%;
            transition: background-color 0.3s;
        }

        .volume-and-extra-controls-jg {
            display: flex; align-items: center; justify-content: space-between; 
            width: 100%; max-width: 400px; /* overridden by Tailwind */
        }
        .volume-fruit-jg { display: flex; align-items: center; gap: 0.5rem; }
        .animal-icon { font-size: 1.2rem; color: var(--jg-text-shadow); }
        .fruit-slider {
            -webkit-appearance: none; appearance: none; width: 120px; height: 10px;
            background: var(--jg-surface-bark); border-radius: 5px; cursor: pointer;
            transition: background-color 0.3s;
        }
        .fruit-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            background: var(--jg-accent-sunburst);
            border-radius: 50%; border: 1px solid color-mix(in srgb, var(--jg-accent-sunburst) 80%, black); /* Darker sunburst for border */
            transition: background-color 0.3s, border-color 0.3s;
        }
        #btn-pip-jg {
            background-color: transparent; border: 1px solid var(--jg-text-shadow);
            color: var(--jg-text-shadow); width: 36px; height: 36px;
            border-radius: 50%; font-size: 0.9rem; margin-left: 1rem; /* overridden by Tailwind for mobile */
            transition: all 0.2s ease;
        }
        #btn-pip-jg:hover { border-color: var(--jg-accent-waterfall); color: var(--jg-accent-waterfall); transform: scale(1.1); }
        #btn-pip-jg:disabled { opacity: 0.5; cursor: not-allowed; }


        .explorers-log {
            /* flex: 2; overridden by Tailwind */ background-color: rgba(var(--jg-surface-bark-rgb), 0.65);
            border-radius: 15px; border: 2px solid var(--jg-border-vine);
            padding: 1rem; /* overridden by Tailwind */ display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .log-tabs-jg { display: flex; border-bottom: 2px solid var(--jg-border-vine); margin-bottom: 1rem; /* overridden by Tailwind */ transition: border-color 0.3s;}
        .log-tab-jg {
            flex-grow: 1; /* overridden by Tailwind */ padding: 0.75rem 0.5rem; /* overridden by Tailwind */ font-family: var(--font-display-jg); font-size: 1.1rem; /* overridden by Tailwind */
            color: var(--jg-text-earth); border: none; background: transparent;
            position: relative; opacity: 0.7; transition: opacity 0.2s, color 0.2s;
            cursor: pointer; 
        }
        .log-tab-jg:hover { opacity: 1; color: var(--jg-accent-sunburst); }
        .log-tab-jg.active { opacity: 1; color: var(--jg-accent-sunburst); font-weight: 700; }
        .log-tab-jg.active::after {
            content: ''; position: absolute; bottom: -2px; left: 10%; width: 80%; height: 3px;
            background-color: var(--jg-accent-sunburst); border-radius: 1.5px;
            transition: background-color 0.3s;
        }
        .log-tab-jg i { margin-right: 0.4rem; }
        #queue-count-jg {
            background: var(--jg-accent-waterfall); color: white; font-size: 0.7rem;
            padding: 1px 5px; border-radius: 8px; margin-left: 0.3rem;
            font-family: var(--font-body-jg); display: none; 
        }

        .log-content-jg { flex-grow: 1; overflow-y: auto; }
        .log-panel-jg { display: none; padding-top: 0.5rem; }
        .log-panel-jg.active { display: block; animation: revealPanel 0.4s ease-in-out; }
        @keyframes revealPanel { from { opacity:0; transform:scale(0.98); } to { opacity:1; transform:scale(1); } }

        .log-entry-jg {
            display: flex; align-items: center; padding: 0.75rem;
            margin-bottom: 0.5rem; border-radius: 10px;
            background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.55);
            transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
            cursor: pointer; 
            border: 1px solid transparent; /* For hover/active states */
        }
        .log-entry-jg:hover {
            background-color: rgba(var(--jg-surface-leaf-rgb),0.5);
            transform: translateX(5px);
        }
        .log-entry-jg.active-song {
            background-color: rgba(var(--jg-accent-canopy-rgb),0.4);
            border-left: 4px solid var(--jg-accent-canopy);
            padding-left: calc(0.75rem - 4px); /* Adjust padding for border */
        }
        .log-entry-jg.dragging-jg {
            opacity: 0.4; background-color: rgba(var(--jg-accent-sunburst-rgb), 0.3); 
            border: 2px dashed var(--jg-accent-sunburst);
        }
        .drag-over-placeholder-jg { height: 2px; background-color: var(--jg-accent-sunburst); margin: 2px 0; border-radius: 1px; pointer-events: none; }
        .log-entry-jg .edited-indicator-jg { font-size: 0.7rem; color: var(--jg-accent-waterfall); margin-left: 0.5rem; opacity: 0.7;}
        .log-entry-jg .img-placeholder.list-thumb-placeholder, .log-entry-jg > img {
            width: 40px; height: 40px; border-radius: 6px; margin-right: 0.75rem;
            background-color: var(--jg-text-shadow);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--jg-bg-forest-floor);
            object-fit: cover; flex-shrink: 0; 
        }

        .log-entry-jg > div { flex-grow: 1; overflow:hidden; min-width: 0; }
        .log-entry-jg .title { display: block; font-weight: 600; color: var(--jg-text-light); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .log-entry-jg .artist { display: block; font-size: 0.85rem; color: var(--jg-text-earth); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .log-entry-jg .duration { font-size: 0.85rem; color: var(--jg-text-shadow); margin-left: auto; padding-left:0.5rem; flex-shrink: 0; }
        
        .log-entry-actions-jg { display: flex; align-items: center; flex-shrink: 0; margin-left: 0.25rem;}
        .log-entry-jg .song-item-action-jg { background: none; border: none; padding: 0.3rem 0.4rem; cursor: pointer; }
        .log-entry-jg .song-item-action-jg i { font-size: 1rem; color: var(--jg-text-shadow); transition: color 0.2s; }
        .log-entry-jg:hover .song-item-action-jg i { color: var(--jg-accent-sunburst); }
        .log-entry-jg .song-item-action-jg.favorite-action-jg i.fa-heart { color: var(--jg-accent-sunburst); } 
        .log-entry-jg:hover .song-item-action-jg.favorite-action-jg i.fa-heart { color: var(--jg-accent-waterfall); } 
        .log-entry-jg .song-item-action-jg.remove-from-playlist-action-jg i { color: var(--jg-text-shadow); } 
        .log-entry-jg:hover .song-item-action-jg.remove-from-playlist-action-jg i { color: #EF4444; } 

        .log-entry-jg > i.fa-feather-alt, .log-entry-jg > i.fa-play-circle {
             font-size: 1rem; color: var(--jg-text-shadow); transition: color 0.2s; margin-left: auto; padding-left:0.5rem; flex-shrink: 0;
        }
        .log-entry-jg:hover > i.fa-feather-alt { color: var(--jg-accent-sunburst); }

        .log-actions-jg {
            padding-top: 1rem; /* overridden by Tailwind */ border-top: 1px solid var(--jg-border-vine);
            display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; 
            transition: border-color 0.3s;
        }
        .log-actions-jg button {
            background-color: var(--jg-surface-leaf); color: var(--jg-text-light);
            padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--jg-accent-canopy);
            font-size: 0.85rem; font-weight: 500; transition: all 0.2s; cursor: pointer; 
        }
        .log-actions-jg button:hover {
            background-color: var(--jg-accent-canopy);
            transform: translateY(-1px); box-shadow: 0 2px 8px var(--jg-shadow-light);
        }
        .log-actions-jg button i { margin-right: 0.4rem; }

        .loop-indicator-jg {
            position: absolute; top: 0px; right: 5px; font-size: 0.6rem; font-weight: bold;
            background-color: var(--jg-accent-sunburst); color: var(--jg-bg-deep-jungle);
            border-radius: 50%; width: 12px; height: 12px;
            line-height: 12px; text-align: center; font-family: var(--font-body-jg);
        }
        .img-placeholder { display: inline-block; background-color: var(--jg-placeholder-bg); object-fit: cover; }
        
        #song-context-menu-jg {
            position: fixed; z-index: 10000;
            background-color: var(--jg-bg-forest-floor);
            border: 1px solid var(--jg-border-vine);
            border-radius: 8px; box-shadow: 0 2px 10px var(--jg-shadow-light);
            padding: 0.5rem 0; min-width: 150px;
        }
        #song-context-menu-jg ul { list-style: none; margin: 0; padding: 0; }
        #song-context-menu-jg li { padding: 0.5rem 1rem; color: var(--jg-text-light); cursor: pointer; font-size: 0.9rem; }
        #song-context-menu-jg li:hover { background-color: var(--jg-surface-leaf); }

        /* @media (max-width: 1024px) { ... (Responsive styles - no major theme-specific changes here) ... } */
        /* @media (max-width: 767px) - Styles from this block are largely replaced by Tailwind's mobile-first + md: prefixes */
        /*
        @media (max-width: 767px) { 
            .player-controls-jg { flex-wrap: wrap; justify-content: center;} // Handled by Tailwind
            .volume-and-extra-controls-jg { max-width: 100%; flex-direction: column; gap: 0.5rem; } // Handled by Tailwind
            #btn-pip-jg { margin-left: 0; margin-top: 0.5rem; } // Handled by Tailwind
        }
        */

        /* --- THEME DEFINITIONS --- */
        /* Default Dark Theme (Applied by :root and body.theme-dark-jg) */
        body.theme-dark-jg .app-safari-hut { background-color: rgba(26, 42, 42, 0.75); /* border-color set by media query or default */ }
        body.theme-dark-jg #animal-tracker { color: var(--jg-text-light); }
        body.theme-dark-jg #animal-tracker::placeholder { color: var(--jg-text-shadow); }
        body.theme-dark-jg .control-rock { border-color: #5C4033; } /* Specific dark border for rocks */
        body.theme-dark-jg .control-rock.play { color: var(--jg-text-light); } /* Ensure light icon on canopy */


        /* Light Theme */
        body.theme-light-jg {
            --jg-bg-deep-jungle: #F0F4F8; --jg-bg-forest-floor: #FFFFFF;
            --jg-surface-bark: #D3C1B3; --jg-surface-leaf: #A8D8B5;
            --jg-accent-sunburst: #FF8F00; --jg-accent-canopy: #388E3C;
            --jg-accent-waterfall: #1976D2; --jg-text-light: #212121; /* Dark text */
            --jg-text-earth: #5D4037; --jg-text-shadow: #8D9499;
            --jg-border-vine: #A1887F;

            --jg-surface-bark-rgb: 211, 193, 179; --jg-surface-leaf-rgb: 168, 216, 181;
            --jg-bg-forest-floor-rgb: 255, 255, 255; --jg-accent-canopy-rgb: 56, 142, 60;
            --jg-accent-sunburst-rgb: 255, 143, 0;
        }
        body.theme-light-jg .app-safari-hut { background-color: rgba(245, 247, 249, 0.85); }
        body.theme-light-jg #animal-tracker { color: var(--jg-text-light); }
        body.theme-light-jg #animal-tracker::placeholder { color: var(--jg-text-shadow); }
        body.theme-light-jg .control-rock { border-color: var(--jg-border-vine); }
        body.theme-light-jg .control-rock.play { color: #FFFFFF; }
        body.theme-light-jg .log-entry-jg .title { color: var(--jg-text-light); }
        body.theme-light-jg .log-entry-jg .artist { color: var(--jg-text-earth); }


        /* Ocean Breeze Theme */
        body.theme-ocean-breeze-jg {
            --jg-bg-deep-jungle: #E1F5FE; --jg-bg-forest-floor: #FFFFFF;
            --jg-surface-bark: #B0BEC5; --jg-surface-leaf: #80CBC4;
            --jg-accent-sunburst: #FFC107; --jg-accent-canopy: #00796B;
            --jg-accent-waterfall: #03A9F4; --jg-text-light: #263238; /* Dark text */
            --jg-text-earth: #455A64; --jg-text-shadow: #78909C;
            --jg-border-vine: #90A4AE;

            --jg-surface-bark-rgb: 176, 190, 197; --jg-surface-leaf-rgb: 128, 203, 196;
            --jg-bg-forest-floor-rgb: 255, 255, 255; --jg-accent-canopy-rgb: 0, 121, 107;
            --jg-accent-sunburst-rgb: 255, 193, 7;
        }
        body.theme-ocean-breeze-jg .app-safari-hut { background-color: rgba(225, 245, 254, 0.85); }
        body.theme-ocean-breeze-jg #animal-tracker { color: var(--jg-text-light); }
        body.theme-ocean-breeze-jg #animal-tracker::placeholder { color: var(--jg-text-shadow); }
        body.theme-ocean-breeze-jg .control-rock { border-color: var(--jg-border-vine); }
        body.theme-ocean-breeze-jg .control-rock.play { color: #FFFFFF; }
        body.theme-ocean-breeze-jg .log-entry-jg .title { color: var(--jg-text-light); }
        body.theme-ocean-breeze-jg .log-entry-jg .artist { color: var(--jg-text-earth); }


        /* Forest Dawn Theme */
        body.theme-forest-dawn-jg {
            --jg-bg-deep-jungle: #1B262C; --jg-bg-forest-floor: #39322E;
            --jg-surface-bark: #5D4037; --jg-surface-leaf: #689F38;
            --jg-accent-sunburst: #FFA000; --jg-accent-canopy: #9CCC65;
            --jg-accent-waterfall: #29B6F6; --jg-text-light: #F5F5F5; /* Bright text */
            --jg-text-earth: #BCAAA4; --jg-text-shadow: #90A4AE;
            --jg-border-vine: #4E342E;

            --jg-surface-bark-rgb: 93, 64, 55; --jg-surface-leaf-rgb: 104, 159, 56;
            --jg-bg-forest-floor-rgb: 57, 50, 46; --jg-accent-canopy-rgb: 156, 204, 101;
            --jg-accent-sunburst-rgb: 255, 160, 0;
        }
        body.theme-forest-dawn-jg .app-safari-hut { background-color: rgba(40, 53, 59, 0.8); }
        body.theme-forest-dawn-jg .control-rock { border-color: var(--jg-border-vine); }
        body.theme-forest-dawn-jg .control-rock.play { color: var(--jg-text-light); }


        /* Neon Noir Theme */
        body.theme-neon-noir-jg {
            --jg-bg-deep-jungle: #0D0D0D; --jg-bg-forest-floor: #1A1A1A;
            --jg-surface-bark: #2C2C2C; --jg-surface-leaf: #3C3C3C;
            --jg-accent-sunburst: #F000B8; --jg-accent-canopy: #00F0E0;
            --jg-accent-waterfall: #30A0FF; --jg-text-light: #E0E0E0; /* Bright text */
            --jg-text-earth: #A0A0A0; --jg-text-shadow: #606060;
            --jg-border-vine: #4A4A4A;

            --jg-surface-bark-rgb: 44, 44, 44; --jg-surface-leaf-rgb: 60, 60, 60;
            --jg-bg-forest-floor-rgb: 26, 26, 26; --jg-accent-canopy-rgb: 0, 240, 224;
            --jg-accent-sunburst-rgb: 240, 0, 184;
        }
        body.theme-neon-noir-jg .app-safari-hut {
            background-color: rgba(10, 10, 10, 0.85);
            /* border and box-shadow set by media query for desktop */
        }
        body.theme-neon-noir-jg .safari-map-bar { background-color: rgba(var(--jg-surface-bark-rgb), 0.9); border-bottom: 2px solid var(--jg-accent-sunburst); }
        body.theme-neon-noir-jg .compass-logo i { color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .text-accent-jg { color: var(--jg-accent-sunburst); }
        body.theme-neon-noir-jg #animal-tracker { color: var(--jg-text-light); border: 1px solid var(--jg-text-shadow); }
        body.theme-neon-noir-jg #animal-tracker::placeholder { color: var(--jg-text-shadow); }
        body.theme-neon-noir-jg .tool-btn-jg { background-color: var(--jg-surface-leaf); border: 1px solid var(--jg-accent-waterfall); color: var(--jg-accent-waterfall); }
        body.theme-neon-noir-jg .tool-btn-jg:hover { background-color: var(--jg-accent-waterfall); color: var(--jg-bg-deep-jungle); }
        body.theme-neon-noir-jg .watering-hole-player { border: 2px solid var(--jg-accent-sunburst); }
        body.theme-neon-noir-jg #main-album-art-jg.album-art-placeholder { border: 4px solid var(--jg-accent-canopy); background-color: var(--jg-surface-bark); color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .control-rock { background-color: var(--jg-surface-bark); border: 2px solid var(--jg-accent-waterfall); color: var(--jg-accent-waterfall); }
        body.theme-neon-noir-jg .control-rock.play { background-color: var(--jg-accent-sunburst); border-color: var(--jg-accent-sunburst); color: var(--jg-bg-deep-jungle); }
        body.theme-neon-noir-jg .control-rock.active-control, body.theme-neon-noir-jg #btn-playback-rate-jg.active-control { color: var(--jg-accent-canopy) !important; border-color: var(--jg-accent-canopy) !important; box-shadow: 0 0 10px var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .liana-slider::-webkit-slider-thumb { background-color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .fruit-slider::-webkit-slider-thumb { background: var(--jg-accent-sunburst); border-color: var(--jg-accent-sunburst); }
        body.theme-neon-noir-jg .explorers-log { background-color: rgba(var(--jg-surface-bark-rgb), 0.7); border: 2px solid var(--jg-accent-waterfall); }
        body.theme-neon-noir-jg .log-tab-jg:hover { color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .log-tab-jg.active { color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .log-tab-jg.active::after { background-color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .log-entry-jg { background-color: rgba(var(--jg-bg-forest-floor-rgb), 0.8); }
        body.theme-neon-noir-jg .log-entry-jg:hover { background-color: rgba(var(--jg-surface-leaf-rgb),0.7); border-color: var(--jg-accent-sunburst); }
        body.theme-neon-noir-jg .log-entry-jg.active-song { background-color: rgba(var(--jg-accent-canopy-rgb),0.4); border-left-color: var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .log-actions-jg button { background-color: var(--jg-surface-leaf); color: var(--jg-accent-canopy); border: 1px solid var(--jg-accent-canopy); }
        body.theme-neon-noir-jg .log-actions-jg button:hover { background-color: var(--jg-accent-canopy); color: var(--jg-bg-deep-jungle); }


        /* Modal Styling based on theme type */
        /* Light Themes Modals */
        body.modal-light-theme-jg #createPlaylistModalJG .bg-jg-surface-bark,
        body.modal-light-theme-jg #addToPlaylistModalJG .bg-jg-surface-bark,
        body.modal-light-theme-jg #editSongModalJG .bg-jg-surface-bark {
            background-color: var(--jg-bg-forest-floor) !important; 
            color: var(--jg-text-light) !important; /* Modal text color */
        }
        body.modal-light-theme-jg #createPlaylistModalJG .text-jg-accent-sunburst, /* Headers in modals */
        body.modal-light-theme-jg #addToPlaylistModalJG .text-jg-accent-sunburst,
        body.modal-light-theme-jg #editSongModalJG .text-jg-accent-sunburst {
             color: var(--jg-accent-canopy) !important; /* Use canopy for headers in light modal */
        }
        body.modal-light-theme-jg #newPlaylistNameJG,
        body.modal-light-theme-jg #editSongTitleJG,
        body.modal-light-theme-jg #editSongArtistJG {
            background-color: var(--jg-surface-bark) !important; 
            border-color: var(--jg-border-vine) !important;
            color: var(--jg-text-light) !important;
        }
        body.modal-light-theme-jg #newPlaylistNameJG::placeholder,
        body.modal-light-theme-jg #editSongTitleJG::placeholder,
        body.modal-light-theme-jg #editSongArtistJG::placeholder {
            color: var(--jg-text-shadow) !important;
        }
        body.modal-light-theme-jg #cancelCreatePlaylistJG,
        body.modal-light-theme-jg #cancelAddToPlaylistJG,
        body.modal-light-theme-jg #cancelEditSongJG {
            background-color: var(--jg-text-shadow) !important;
            color: var(--jg-bg-deep-jungle) !important; /* Light text on greyish button */
        }
        body.modal-light-theme-jg #confirmCreatePlaylistJG,
        body.modal-light-theme-jg #confirmEditSongJG {
            background-color: var(--jg-accent-canopy) !important;
            color: #FFFFFF !important; 
        }
        body.modal-light-theme-jg #addToPlaylistListJG .playlist-select-item-jg:hover {
            background-color: rgba(var(--jg-surface-leaf-rgb), 0.4) !important;
        }
        body.modal-light-theme-jg #song-context-menu-jg { background-color: var(--jg-bg-forest-floor); border-color: var(--jg-border-vine); }
        body.modal-light-theme-jg #song-context-menu-jg li { color: var(--jg-text-light); }
        body.modal-light-theme-jg #song-context-menu-jg li:hover { background-color: var(--jg-surface-leaf); }

        /* Dark Themes Modals (default, forest-dawn, neon-noir if not overridden by neon-noir specific) */
        /* Default styles for modals in dark themes (they already use main vars) */
        #createPlaylistModalJG .bg-jg-surface-bark,
        #addToPlaylistModalJG .bg-jg-surface-bark,
        #editSongModalJG .bg-jg-surface-bark {
            /* These will use the current theme's --jg-surface-bark etc. */
        }
        /* Specific for Neon Noir modals if needed, or they inherit from dark */
        body.theme-neon-noir-jg #createPlaylistModalJG .bg-jg-surface-bark,
        body.theme-neon-noir-jg #addToPlaylistModalJG .bg-jg-surface-bark,
        body.theme-neon-noir-jg #editSongModalJG .bg-jg-surface-bark {
            background-color: var(--jg-bg-forest-floor) !important; /* Very dark bg for neon */
            border: 1px solid var(--jg-accent-canopy);
        }
        body.theme-neon-noir-jg #createPlaylistModalJG .text-jg-accent-sunburst, /* Headers */
        body.theme-neon-noir-jg #addToPlaylistModalJG .text-jg-accent-sunburst,
        body.theme-neon-noir-jg #editSongModalJG .text-jg-accent-sunburst {
             color: var(--jg-accent-canopy) !important;
        }
        body.theme-neon-noir-jg #newPlaylistNameJG,
        body.theme-neon-noir-jg #editSongTitleJG,
        body.theme-neon-noir-jg #editSongArtistJG {
            background-color: var(--jg-surface-bark) !important; 
            border-color: var(--jg-accent-waterfall) !important;
            color: var(--jg-text-light) !important;
        }
        body.theme-neon-noir-jg #confirmCreatePlaylistJG,
        body.theme-neon-noir-jg #confirmEditSongJG {
            background-color: var(--jg-accent-sunburst) !important;
            color: var(--jg-bg-deep-jungle) !important; /* Black text on neon pink */
        }
        body.theme-neon-noir-jg #song-context-menu-jg { background-color: var(--jg-bg-forest-floor); border: 1px solid var(--jg-accent-canopy); }
        body.theme-neon-noir-jg #song-context-menu-jg li:hover { background-color: var(--jg-accent-sunburst); color: var(--jg-bg-deep-jungle); }

    </style>
</head>
<body class="theme-dark-jg"> <!-- Default theme applied here -->

    <div class="jungle-background-layers">
        <div class="layer layer-1"></div>
        <div class="layer layer-2"></div>
        <div class="layer layer-3"></div>
    </div>

    <div class="app-safari-hut">

        <header class="safari-map-bar flex-col md:flex-row items-stretch md:items-center md:justify-between gap-2 p-3 md:p-4 md:px-6">
            <div class="compass-logo self-center md:self-auto">
                <i class="fas fa-compass"></i>
                <span>Jungle<span class="text-accent-jg">Groove</span></span>
            </div>
            <div class="search-outpost w-full md:w-auto order-last md:order-none">
                <i class="fas fa-binoculars"></i>
                <input type="text" id="animal-tracker" placeholder="Track your tunes..." class="flex-grow md:w-[250px]">
                <button id="clear-search-btn-jg" style="display:none;" title="クリア"><i class="fas fa-times"></i></button>
            </div>
            <div class="safari-tools self-center md:self-auto">
                <button id="weather-toggle" class="tool-btn-jg" title="テーマ切替"><i class="fas fa-palette"></i></button>
                <button id="profile-ranger" class="tool-btn-jg profile">
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Ranger Profile" class="img-placeholder profile-avatar-placeholder">
                </button>
            </div>
        </header>

        <main class="safari-zone flex-col md:flex-row p-2 md:p-[1.5rem] gap-2 md:gap-[1.5rem]">
            <section class="watering-hole-player md:flex-[3] p-3 md:p-[2rem] min-h-0">
                <div class="album-canopy w-40 h-40 sm:w-48 sm:h-48 md:w-[280px] md:h-[280px] mb-3 md:mb-[1.5rem]">
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Album Art" id="main-album-art-jg" class="img-placeholder album-art-placeholder">
                    <div class="leaf-overlay"></div>
                </div>
                <div class="track-details-jg mb-3 md:mb-[1.5rem]">
                    <h2 id="song-title-jg" class="text-xl sm:text-2xl md:text-[2.5rem]">Wild Rhythms</h2>
                    <p id="artist-name-jg" class="text-sm sm:text-base md:text-[1.1rem]">The Jungle Cats</p>
                </div>
                <div class="player-controls-jg flex items-center gap-2 md:gap-4 mb-3 md:mb-[1.5rem] flex-wrap justify-center md:flex-nowrap">
                    <button class="control-rock small" id="btn-shuffle-jg" title="Shuffle (S)"><i class="fas fa-random"></i></button>
                    <button class="control-rock" id="btn-prev-jg" title="Previous (P)"><i class="fas fa-step-backward"></i></button>
                    <button class="control-rock play" id="btn-play-jg" title="Play/Pause (Space)"><i class="fas fa-play"></i></button>
                    <button class="control-rock" id="btn-next-jg" title="Next (N)"><i class="fas fa-step-forward"></i></button>
                    <button class="control-rock small" id="btn-loop-jg" title="Loop (L)"><i class="fas fa-redo-alt"></i></button>
                    <button class="control-rock small" id="btn-playback-rate-jg" title="再生速度">1x</button> 
                </div>
                <div class="progress-liana-jg w-full max-w-sm md:max-w-[400px] mb-2 md:mb-4">
                    <span id="current-time-jg">0:00</span>
                    <input type="range" id="progress-slider-jg" class="liana-slider" value="0" title="Seek (←/→)">
                    <span id="total-time-jg">0:00</span>
                </div>
                <div class="volume-and-extra-controls-jg w-full max-w-sm md:max-w-[400px] flex flex-col md:flex-row items-center md:justify-between gap-2 md:gap-0">
                    <div class="volume-fruit-jg">
                        <i class="fas fa-volume-mute animal-icon monkey" title="Mute/Unmute (M)"></i>
                        <input type="range" id="volume-slider-jg" class="fruit-slider" value="75" min="0" max="100" title="Volume (↑/↓)">
                        <i class="fas fa-volume-up animal-icon parrot" title="Volume"></i>
                    </div>
                    <button id="btn-pip-jg" class="tool-btn-jg ml-0 mt-2 md:mt-0 md:ml-4" title="ミニプレイヤー" style="display: none;"> 
                        <i class="fas fa-photo-video"></i>
                    </button>
                </div>
            </section>

            <aside class="explorers-log md:flex-[2] p-2 md:p-[1rem] min-h-0">
                <div class="log-tabs-jg flex border-b-2 [border-color:var(--jg-border-vine)] mb-2 md:mb-[1rem] overflow-x-auto whitespace-nowrap pb-px">
                    <button class="log-tab-jg active flex-shrink-0 px-2 py-2 text-sm md:text-[1.1rem] md:px-2 md:py-3 md:flex-grow" data-panel="log-library"><i class="fas fa-tree"></i> Library</button>
                    <button class="log-tab-jg flex-shrink-0 px-2 py-2 text-sm md:text-[1.1rem] md:px-2 md:py-3 md:flex-grow" data-panel="log-paths"><i class="fas fa-map-signs"></i> Playlists</button>
                    <button class="log-tab-jg flex-shrink-0 px-2 py-2 text-sm md:text-[1.1rem] md:px-2 md:py-3 md:flex-grow" data-panel="log-discoveries"><i class="fas fa-paw"></i> Queue <span id="queue-count-jg">0</span></button>
                    <button class="log-tab-jg flex-shrink-0 px-2 py-2 text-sm md:text-[1.1rem] md:px-2 md:py-3 md:flex-grow" data-panel="log-trophies"><i class="fas fa-gem"></i> Favorites</button>
                    <button class="log-tab-jg flex-shrink-0 px-2 py-2 text-sm md:text-[1.1rem] md:px-2 md:py-3 md:flex-grow" data-panel="log-history"><i class="fas fa-history"></i> History</button>
                </div>
                <div class="log-content-jg">
                    <div id="log-library" class="log-panel-jg active"></div>
                    <div id="log-paths" class="log-panel-jg"></div>
                    <div id="log-discoveries" class="log-panel-jg"></div>
                    <div id="log-trophies" class="log-panel-jg"></div>
                    <div id="log-history" class="log-panel-jg"></div>
                </div>
                 <div id="log-actions-container-jg" class="log-actions-jg pt-2 md:pt-[1rem]"></div>
            </aside>
        </main>
    </div>
    
    <!-- Create Playlist Modal -->
    <div id="createPlaylistModalJG" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-jg-surface-bark p-6 rounded-lg shadow-xl w-full max-w-md text-jg-text-light modal-dialog-jg">
            <h3 class="font-display-jg text-2xl mb-4 text-jg-accent-sunburst">新しい道 (プレイリスト) を作成</h3>
            <input type="text" id="newPlaylistNameJG" class="w-full p-2 rounded bg-jg-bg-forest-floor border border-jg-border-vine text-jg-text-light placeholder-jg-text-shadow focus:ring-2 focus:ring-jg-accent-canopy outline-none modal-input-jg" placeholder="プレイリスト名を入力...">
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelCreatePlaylistJG" class="px-4 py-2 rounded bg-jg-text-shadow hover:bg-opacity-80 transition-colors">キャンセル</button>
                <button id="confirmCreatePlaylistJG" class="px-4 py-2 rounded bg-jg-accent-canopy hover:bg-opacity-80 text-white transition-colors">作成</button>
            </div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="addToPlaylistModalJG" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-jg-surface-bark p-6 rounded-lg shadow-xl w-full max-w-md text-jg-text-light modal-dialog-jg">
            <h3 class="font-display-jg text-2xl mb-1 text-jg-accent-sunburst">プレイリストに追加</h3>
            <p class="text-sm text-jg-text-earth mb-4" id="addToPlaylistSongTitleJG">曲名...</p>
            <div id="addToPlaylistListJG" class="max-h-60 overflow-y-auto mb-4 border border-jg-border-vine rounded"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelAddToPlaylistJG" class="px-4 py-2 rounded bg-jg-text-shadow hover:bg-opacity-80 transition-colors">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- Edit Song Info Modal -->
    <div id="editSongModalJG" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-jg-surface-bark p-6 rounded-lg shadow-xl w-full max-w-md text-jg-text-light modal-dialog-jg">
            <h3 class="font-display-jg text-2xl mb-4 text-jg-accent-sunburst">曲情報を編集</h3>
            <div class="mb-4">
                <label for="editSongTitleJG" class="block text-sm font-medium text-jg-text-earth mb-1">タイトル:</label>
                <input type="text" id="editSongTitleJG" class="w-full p-2 rounded bg-jg-bg-forest-floor border border-jg-border-vine text-jg-text-light placeholder-jg-text-shadow focus:ring-2 focus:ring-jg-accent-canopy outline-none modal-input-jg">
            </div>
            <div class="mb-6">
                <label for="editSongArtistJG" class="block text-sm font-medium text-jg-text-earth mb-1">アーティスト:</label>
                <input type="text" id="editSongArtistJG" class="w-full p-2 rounded bg-jg-bg-forest-floor border border-jg-border-vine text-jg-text-light placeholder-jg-text-shadow focus:ring-2 focus:ring-jg-accent-canopy outline-none modal-input-jg">
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancelEditSongJG" class="px-4 py-2 rounded bg-jg-text-shadow hover:bg-opacity-80 transition-colors">キャンセル</button>
                <button id="confirmEditSongJG" class="px-4 py-2 rounded bg-jg-accent-canopy hover:bg-opacity-80 text-white transition-colors">保存</button>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu (initially hidden) -->
    <div id="song-context-menu-jg" style="display: none;">
        <ul>
            <li data-action="edit-song">情報を編集...</li>
        </ul>
    </div>


    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // jungle_groove_script.js
        // (No changes to JavaScript were requested or made for this responsive UI update)
        console.log("Jungle Groove Initializing...");

        let elementsJG = {}; 
        let appStateJG = {}; 
        let draggedItemJG = null;
        let draggedItemOriginalIndexJG = -1;
        let currentDragContextJG = null; 
        let dragOverPlaceholderJG = null;

        const PLAYBACK_RATES_JG = [0.75, 1, 1.25, 1.5];
        let currentPlaybackRateIndexJG = 1; 
        const AVAILABLE_THEMES_JG = [
            { id: 'theme-dark-jg', name: 'ジャングルナイト (標準)', type: 'dark' },
            { id: 'theme-light-jg', name: 'ジャングルデイ', type: 'light' },
            { id: 'theme-ocean-breeze-jg', name: 'オーシャンブリーズ', type: 'light' },
            { id: 'theme-forest-dawn-jg', name: 'フォレストドーン', type: 'dark' },
            { id: 'theme-neon-noir-jg', name: 'ネオンノワール', type: 'dark' }
        ];
        let currentThemeIndexJG = 0;
        let songMetadataOverridesJG = {}; 
        let currentEditingSongIdJG = null; 
        let currentContextMenuSongIdJG = null; 


        const MAX_HISTORY_JG = 20;
        const VOLUME_STEP_JG = 5;
        const SEEK_STEP_JG = 5; 
        const DEFAULT_TITLE_JG = "Jungle Groove - Wild Music Safari"; 
        const LS_KEYS_JG = {
            HISTORY: 'jungleGrooveHistory', FAVORITES: 'jungleGrooveFavorites',
            PLAYLISTS: 'jungleGroovePlaylists', THEME: 'jungleGrooveThemeId', 
            QUEUE: 'jungleGrooveQueue', VOLUME: 'jungleGrooveVolume',
            PLAYBACK_RATE: 'jungleGroovePlaybackRate', 
            METADATA_OVERRIDES: 'jungleGrooveMetadataOverrides' 
        };

        appStateJG = {
            player: null, songs: [], filteredSongs: [], currentSongIndex: -1,
            isPlaying: false, isShuffle: false, loopMode: 'none', 
            currentPanel: 'log-library', volume: 75, previousVolumeBeforeMute: 75,
            isMuted: false, progressInterval: null, history: [], favorites: [],
            userPlaylists: [], queue: [], currentQueueIndex: -1, playMode: 'library', 
            isPlayerReady: false, snackbarTimeoutId: null, activeModalId: null,
            buttonsForPanel: { 
                'log-library': ['btn-refresh-feed-jg', 'btn-create-playlist-jg'],
                'log-paths': ['btn-refresh-feed-jg', 'btn-create-playlist-jg'], 
                'playlistSongs': ['btn-refresh-feed-jg', 'btn-create-playlist-jg'], 
                'log-discoveries': ['btn-clear-queue-jg', 'btn-refresh-feed-jg', 'btn-create-playlist-jg'],
                'log-trophies': ['btn-refresh-feed-jg', 'btn-create-playlist-jg'],
                'log-history': ['btn-clear-history-jg', 'btn-refresh-feed-jg', 'btn-create-playlist-jg']
            },
            currentViewingPlaylistId: null, currentPlayingPlaylistId: null
        };

        function initializeElementsJG() {
            elementsJG = {
                body: document.body,
                searchInput: document.getElementById('animal-tracker'),
                clearSearchButton: document.getElementById('clear-search-btn-jg'),
                themeToggle: document.getElementById('weather-toggle'),
                profileButton: document.getElementById('profile-ranger'),
                mainAlbumArt: document.getElementById('main-album-art-jg'),
                songTitleDisplay: document.getElementById('song-title-jg'),
                artistNameDisplay: document.getElementById('artist-name-jg'),
                btnShuffle: document.getElementById('btn-shuffle-jg'),
                btnPrev: document.getElementById('btn-prev-jg'),
                btnPlay: document.getElementById('btn-play-jg'),
                btnNext: document.getElementById('btn-next-jg'),
                btnLoop: document.getElementById('btn-loop-jg'),
                btnPlaybackRate: document.getElementById('btn-playback-rate-jg'), 
                btnPip: document.getElementById('btn-pip-jg'), 
                currentTimeDisplay: document.getElementById('current-time-jg'),
                totalTimeDisplay: document.getElementById('total-time-jg'),
                progressSlider: document.getElementById('progress-slider-jg'),
                volumeSlider: document.getElementById('volume-slider-jg'),
                volumeIconMute: document.querySelector('.volume-fruit-jg .fa-volume-mute'),
                volumeIconUp: document.querySelector('.volume-fruit-jg .fa-volume-up'),
                logTabs: document.querySelectorAll('.log-tab-jg'),
                logPanels: document.querySelectorAll('.log-panel-jg'),
                libraryPanel: document.getElementById('log-library'),
                queuePanel: document.getElementById('log-discoveries'),
                favoritesPanel: document.getElementById('log-trophies'),
                historyPanel: document.getElementById('log-history'),
                playlistsPanel: document.getElementById('log-paths'),
                queueCountBadge: document.getElementById('queue-count-jg'),
                youtubePlayerContainer: null,
                editSongModal: document.getElementById('editSongModalJG'),
                editSongTitleInput: document.getElementById('editSongTitleJG'),
                editSongArtistInput: document.getElementById('editSongArtistJG'),
                confirmEditSongButton: document.getElementById('confirmEditSongJG'),
                cancelEditSongButton: document.getElementById('cancelEditSongJG'),
                songContextMenu: document.getElementById('song-context-menu-jg'),
            };
            let ytContainer = document.getElementById('youtube-player-container-jg');
            if (!ytContainer) {
                ytContainer = document.createElement('div');
                ytContainer.id = 'youtube-player-container-jg';
                Object.assign(ytContainer.style, {position: 'absolute', top: '-9999px', left: '-9999px', width: '1px', height: '1px'});
                document.body.appendChild(ytContainer);
            }
            elementsJG.youtubePlayerContainer = ytContainer;
        }

        function onYouTubeIframeAPIReady() {
            if (Object.keys(elementsJG).length === 0) initializeElementsJG(); 
            if (!elementsJG.youtubePlayerContainer) { showSnackbarJG("プレイヤー表示領域なし", "error", 10000); return; }
            try {
                appStateJG.player = new YT.Player(elementsJG.youtubePlayerContainer.id, {
                    height: '1', width: '1',  
                    playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1, 'origin': window.location.origin },
                    events: { 'onReady': onPlayerReadyJG, 'onStateChange': onPlayerStateChangeJG, 'onError': onPlayerErrorJG }
                });
            } catch (e) { showSnackbarJG("YTプレイヤー作成エラー: " + e.message, "error"); }
        }
       
        const youtubeAPI_JG = {
            apiKey: 'AIzaSyCbzvjP9vFa5I8N1qLI5H9LUpYim0nkQS4', 
            channelId: 'UCYAuSEKhuk3v4ZKzm5Lqb1Q', 
            async getLatestVideos(maxResults = 15) { /* ... (Same as previous version) ... */ if (!this.apiKey || this.apiKey === 'YOUR_YOUTUBE_API_KEY_HERE' || this.apiKey.length < 30) { showSnackbarJG("YouTube APIキーが設定されていません。", "error", 10000); return []; } const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${this.channelId}&maxResults=${maxResults}&order=date&type=video&key=${this.apiKey}`; try { const response = await fetch(apiUrl); if (!response.ok) { const errorText = await response.text(); let errorData = null; try { errorData = JSON.parse(errorText); } catch (e) {} throw new Error(errorData?.error?.message || `YouTube APIエラー: ${response.status}`); } const data = await response.json(); return data.items?.map(item => ({ id: item.id.videoId, title: item.snippet.title, artist: item.snippet.channelTitle, thumbnail: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url, duration: "--:--" })) || []; } catch (error) { console.error('getLatestVideos Error:', error); showSnackbarJG(`曲読込エラー: ${error.message}`, "error"); return []; } },
            async getVideoDetails(videoIds) { /* ... (Same as previous version) ... */ if (!videoIds || videoIds.length === 0) return {}; if (!this.apiKey || this.apiKey === 'YOUR_YOUTUBE_API_KEY_HERE' || this.apiKey.length < 30) return {}; const details = {}; for (let i = 0; i < videoIds.length; i += 50) { const chunkIds = videoIds.slice(i, i + 50); try { const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${chunkIds.join(',')}&key=${this.apiKey}`); if (!response.ok) throw new Error(`Video Details API error: ${response.status}`); const data = await response.json(); data.items?.forEach(item => { details[item.id] = item.contentDetails ? this.convertDuration(item.contentDetails.duration) : "--:--"; }); } catch (error) { console.error('getVideoDetails chunk error:', error); chunkIds.forEach(id => { if (!details[id]) details[id] = "--:--"; });} } return details; },
            convertDuration(iso) { /* ... (Same as previous version) ... */ if (!iso) return '--:--'; const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if (!m) return '--:--'; const h = parseInt(m[1]||0), min = parseInt(m[2]||0), s = parseInt(m[3]||0); return h > 0 ? `${h}:${min.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${min}:${s.toString().padStart(2,'0')}`; }
        };
        async function loadInitialSongsJG() { /* ... (Same as previous version) ... */ if (!youtubeAPI_JG.apiKey || youtubeAPI_JG.apiKey === 'YOUR_YOUTUBE_API_KEY_HERE' || youtubeAPI_JG.apiKey.length < 30) { showSnackbarJG("YouTube APIキー未設定。", "error", 10000); if (elementsJG.libraryPanel) showEmptyMessageInPanelJG(elementsJG.libraryPanel, "APIキーエラー", "曲を読込めません。"); return; } if (!elementsJG.libraryPanel) return; showLoadingInPanelJG(elementsJG.libraryPanel, true); let songs = []; try { songs = await youtubeAPI_JG.getLatestVideos(25); } catch (error) { appStateJG.songs = []; appStateJG.filteredSongs = []; if (elementsJG.libraryPanel) { renderSongListJG(elementsJG.libraryPanel, [], 'library'); showLoadingInPanelJG(elementsJG.libraryPanel, false); showEmptyMessageInPanelJG(elementsJG.libraryPanel, "読込失敗", `エラー: ${error.message}`); } return; } if (songs && songs.length > 0) { const videoIds = songs.map(s => s.id).filter(id => id); if (videoIds.length > 0) { try { const durations = await youtubeAPI_JG.getVideoDetails(videoIds); songs = songs.map(song => ({ ...song, artist: song.artist || "Rei Kikuchi", duration: durations[song.id] || "--:--" })); } catch (error) { console.error("Error fetching durations:", error); } } } appStateJG.songs = songs || []; appStateJG.filteredSongs = [...(songs || [])]; if (elementsJG.libraryPanel) { renderSongListJG(elementsJG.libraryPanel, appStateJG.filteredSongs, 'library'); showLoadingInPanelJG(elementsJG.libraryPanel, false); } if ((!songs || songs.length === 0) && elementsJG.libraryPanel) { showEmptyMessageInPanelJG(elementsJG.libraryPanel, "曲なし", "新しい冒険を待とう！");} loadInitialDataJG(true);  }

        function renderSongListJG(panelElement, songsToRender, context) { /* ... (Same as previous version, including context menu and edited indicator) ... */ if (!panelElement) return; panelElement.innerHTML = ''; const isDraggableContext = (context === 'queue' || context === 'playlistSongs'); if (isDraggableContext) { panelElement.removeEventListener('dragover', handleDragOverJG); panelElement.removeEventListener('drop', handleDropJG); panelElement.removeEventListener('dragleave', handleDragLeaveJG); panelElement.addEventListener('dragover', handleDragOverJG); panelElement.addEventListener('drop', (event) => handleDropJG(event, panelElement, context)); panelElement.addEventListener('dragleave', handleDragLeaveJG); } if (!songsToRender || songsToRender.length === 0) { let emptyTitle = "何も見つからない..."; let emptyMessage = "このエリアにはまだ何もないようだ。"; if (context === 'library' && elementsJG.searchInput?.value) { emptyTitle = "検索結果なし"; emptyMessage = `「${escapeHTMLJG(elementsJG.searchInput.value)}」一致なし...`; } else if (context === 'queue') { emptyTitle = "キューは空っぽ"; emptyMessage = "ライブラリから曲を追加！"; } else if (context === 'favorites') { emptyTitle = "お気に入りの宝物なし"; emptyMessage = "曲の羽アイコンをクリック！"; } else if (context === 'history') { emptyTitle = "足跡なし"; emptyMessage = "まだ探検していないようだ。"; } showEmptyMessageInPanelJG(panelElement, emptyTitle, emptyMessage); return; } const fragment = document.createDocumentFragment(); songsToRender.forEach((songData, listIndex) => { if (!songData || !songData.id) return; const displayInfo = getDisplaySongInfoJG(songData.id); const originalSongIndex = appStateJG.songs.findIndex(s => s.id === songData.id); const currentPlayingSong = appStateJG.songs[appStateJG.currentSongIndex]; const isActive = currentPlayingSong && currentPlayingSong.id === songData.id; const isFavorited = appStateJG.favorites.some(fav => fav.id === songData.id); const isEdited = songMetadataOverridesJG[songData.id] ? '<i class="fas fa-edit edited-indicator-jg" title="情報編集済み"></i>' : ''; const entry = document.createElement('div'); entry.className = `log-entry-jg ${isActive ? 'active-song' : ''}`; entry.dataset.id = songData.id; entry.dataset.originalIndex = originalSongIndex; entry.dataset.listIndex = listIndex; if (isDraggableContext) { entry.draggable = true; entry.style.cursor = 'grab'; entry.addEventListener('dragstart', (event) => handleDragStartJG(event, songData.id, listIndex, context)); entry.addEventListener('dragend', handleDragEndJG); } else { entry.style.cursor = 'pointer'; } entry.addEventListener('contextmenu', (e) => { e.preventDefault(); showSongContextMenuJG(e.clientX, e.clientY, songData.id); }); let actionButtonsHTML = ''; if (context !== 'queue') { actionButtonsHTML += `<button class="song-item-action-jg add-to-queue-action-jg" title="キューに追加"><i class="fas fa-stream"></i></button>`; } if (context !== 'queue') { actionButtonsHTML += `<button class="song-item-action-jg add-to-playlist-action-jg" title="プレイリストに追加"><i class="fas fa-folder-plus"></i></button>`; } actionButtonsHTML += `<button class="song-item-action-jg favorite-action-jg" title="${isFavorited ? 'お気に入りから削除' : 'お気に入りに追加'}"><i class="fas ${isFavorited ? 'fa-heart text-jg-accent-sunburst' : 'fa-feather-alt'}"></i></button>`; if (context === 'playlistSongs' && appStateJG.currentViewingPlaylistId) { actionButtonsHTML += `<button class="song-item-action-jg remove-from-playlist-action-jg" title="このプレイリストから削除"><i class="fas fa-minus-circle text-red-500 hover:text-red-400"></i></button>`;} entry.innerHTML = ` <img src="${displayInfo.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${escapeHTMLJG(displayInfo.title || '')}" class="${!displayInfo.thumbnail ? 'img-placeholder list-thumb-placeholder' : ''}"> <div> <span class="title">${escapeHTMLJG(displayInfo.title || '不明なタイトル')} ${isEdited}</span> <span class="artist">${escapeHTMLJG(displayInfo.artist || '不明なアーティスト')}</span> </div> <span class="duration">${songData.duration || '--:--'}</span> <div class="log-entry-actions-jg">${actionButtonsHTML}</div>`; entry.querySelector('.favorite-action-jg')?.addEventListener('click', (e) => { e.stopPropagation(); toggleFavoriteJG(songData.id, e.currentTarget.querySelector('i'), e.currentTarget); }); entry.querySelector('.add-to-queue-action-jg')?.addEventListener('click', (e) => { e.stopPropagation(); addToQueueJG(songData.id); }); entry.querySelector('.add-to-playlist-action-jg')?.addEventListener('click', (e) => { e.stopPropagation(); showAddToPlaylistModalJG(songData.id); }); entry.querySelector('.remove-from-playlist-action-jg')?.addEventListener('click', (e) => { e.stopPropagation(); if (appStateJG.currentViewingPlaylistId) confirmRemoveSongFromPlaylistJG(songData.id, appStateJG.currentViewingPlaylistId, displayInfo.title); }); entry.addEventListener('click', (e) => { if (e.target.closest('.song-item-action-jg') || entry.classList.contains('dragging-jg')) return; const songIdToPlay = entry.dataset.id; const originalIdx = parseInt(entry.dataset.originalIndex, 10); if (isNaN(originalIdx) || originalIdx < 0 || originalIdx >= appStateJG.songs.length) { const freshIndex = appStateJG.songs.findIndex(s => s.id === songIdToPlay); if (freshIndex === -1) { showSnackbarJG("この曲は現在再生不可", "error"); return; } playSongAtIndexJG(freshIndex); return;  } if (context === 'queue') { appStateJG.playMode = 'queue'; appStateJG.currentQueueIndex = parseInt(entry.dataset.listIndex, 10); appStateJG.currentPlayingPlaylistId = null;} else if (context === 'playlistSongs' && appStateJG.currentViewingPlaylistId) { appStateJG.playMode = 'playlist'; appStateJG.currentPlayingPlaylistId = appStateJG.currentViewingPlaylistId; appStateJG.currentQueueIndex = parseInt(entry.dataset.listIndex, 10); } else { appStateJG.playMode = 'library'; appStateJG.currentQueueIndex = -1; appStateJG.currentPlayingPlaylistId = null; } playSongAtIndexJG(originalIdx); }); fragment.appendChild(entry); }); panelElement.appendChild(fragment); }
        function showLoadingInPanelJG(panelElement, isLoading) { /* ... (Same as previous) ... */ if (!panelElement) return; if (isLoading) { panelElement.innerHTML = `<div class="flex justify-center items-center h-full text-jg-text-shadow"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="ml-2">探検中...</p></div>`; } }
        function showEmptyMessageInPanelJG(panelElement, title, message) { /* ... (Same as previous) ... */ if (!panelElement) return; panelElement.innerHTML = `<div class="text-center p-8 text-jg-text-shadow"><i class="fas fa-map-marked-alt fa-3x mb-4 opacity-50"></i><h4 class="font-display-jg text-xl text-jg-text-earth mb-2">${escapeHTMLJG(title)}</h4><p class="text-sm">${escapeHTMLJG(message)}</p></div>`; }
        function updatePlayerUIGJ(song) { /* ... (Same as previous, uses getDisplaySongInfoJG) ... */ const playerElement = document.querySelector('.watering-hole-player'); if (song && song.id) { const displayInfo = getDisplaySongInfoJG(song.id); elementsJG.mainAlbumArt.src = displayInfo.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; if (!displayInfo.thumbnail) { elementsJG.mainAlbumArt.classList.add('album-art-placeholder'); elementsJG.mainAlbumArt.innerHTML = '<i class="fas fa-music"></i>'; } else { elementsJG.mainAlbumArt.classList.remove('album-art-placeholder'); elementsJG.mainAlbumArt.innerHTML = ''; } elementsJG.songTitleDisplay.textContent = displayInfo.title || "Wild Rhythms"; elementsJG.artistNameDisplay.textContent = displayInfo.artist || "The Jungle Cats"; playerElement?.classList.add('has-song'); } else { elementsJG.mainAlbumArt.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; elementsJG.mainAlbumArt.classList.add('album-art-placeholder'); elementsJG.mainAlbumArt.innerHTML = '<i class="fas fa-music"></i>'; elementsJG.songTitleDisplay.textContent = "Wild Rhythms"; elementsJG.artistNameDisplay.textContent = "The Jungle Cats"; elementsJG.currentTimeDisplay.textContent = "0:00"; elementsJG.totalTimeDisplay.textContent = "0:00"; elementsJG.progressSlider.value = 0; playerElement?.classList.remove('has-song'); } updatePlayPauseButtonJG(); updateActiveListItemJG(); updateDocumentTitleJG();  }
        function updatePlayPauseButtonJG() { /* ... (Same as previous) ... */ if (!elementsJG.btnPlay) return; const i = appStateJG.isPlaying ? 'fa-pause':'fa-play'; elementsJG.btnPlay.innerHTML = `<i class="fas ${i}"></i>`; document.querySelector('.watering-hole-player')?.classList.toggle('is-playing', appStateJG.isPlaying); }
        function updateActiveListItemJG() { /* ... (Same as previous) ... */ document.querySelectorAll('.log-entry-jg.active-song').forEach(el=>el.classList.remove('active-song')); if(appStateJG.currentSongIndex!==-1&&appStateJG.songs&&appStateJG.currentSongIndex<appStateJG.songs.length){const cSId=appStateJG.songs[appStateJG.currentSongIndex]?.id;if(cSId){document.querySelectorAll(`.log-entry-jg[data-id="${cSId}"]`).forEach(item=>item.classList.add('active-song'));}}}
        function updateDocumentTitleJG() { /* ... (Same as previous, uses getDisplaySongInfoJG) ... */ if (appStateJG.currentSongIndex === -1 || !appStateJG.songs[appStateJG.currentSongIndex]) { document.title = DEFAULT_TITLE_JG; return; } const song = appStateJG.songs[appStateJG.currentSongIndex]; if (!song) { document.title = DEFAULT_TITLE_JG; return; } const displayInfo = getDisplaySongInfoJG(song.id); const prefix = appStateJG.isPlaying ? "▶ " : "❚❚ "; document.title = `${prefix}${displayInfo.title} - ${displayInfo.artist} | Jungle Groove`; }
        
        function playSongAtIndexJG(index) { /* ... (Same as previous) ... */ if (index < 0 || !appStateJG.songs || index >= appStateJG.songs.length) { showSnackbarJG("無効な曲index", "error"); return; } appStateJG.currentSongIndex = index; const song = appStateJG.songs[index]; if (!song || !song.id) { showSnackbarJG("曲情報不正", "error"); updatePlayerUIGJ(null); return; } updatePlayerUIGJ(song); if (appStateJG.player && appStateJG.isPlayerReady) { try { appStateJG.player.loadVideoById(song.id); } catch (error) { console.error("loadVideoById Error:", error); showSnackbarJG("動画読込失敗", "error"); } } else { if (!appStateJG.isPlayerReady) showSnackbarJG("プレイヤー準備未了", "warning"); else if (!song.id) showSnackbarJG("曲IDなし", "error"); } addToHistoryJG(song); if (appStateJG.currentPanel === 'log-history' && elementsJG.historyPanel) renderHistoryListJG(); }
        function togglePlayPauseJG() { /* ... (Same as previous) ... */ if(!appStateJG.player||!appStateJG.isPlayerReady){showSnackbarJG("プレイヤー準備未了","warning");return;}if(appStateJG.currentSongIndex===-1&&appStateJG.songs&&appStateJG.songs.length>0){appStateJG.playMode='library';appStateJG.currentQueueIndex=-1;playSongAtIndexJG(0);return;}if(appStateJG.currentSongIndex===-1&&(!appStateJG.songs||appStateJG.songs.length===0)){showSnackbarJG("再生曲なし","info");return;}if(appStateJG.isPlaying){appStateJG.player.pauseVideo();}else{appStateJG.player.playVideo();}}
        function playNextJG() { /* ... (Same as previous) ... */ if (!appStateJG.songs || appStateJG.songs.length === 0) { showSnackbarJG("リストに曲なし", "info"); return; } let nextSongOriginalIndex = -1, currentList, nextListIndex; if (appStateJG.playMode === 'queue' && appStateJG.queue.length > 0) { currentList = appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s); nextListIndex = appStateJG.currentQueueIndex + 1; if (nextListIndex >= currentList.length) { if (appStateJG.loopMode === 'all') nextListIndex = 0; else { showSnackbarJG("キュー再生終了", "info"); appStateJG.isPlaying = false; updatePlayPauseButtonJG(); updateDocumentTitleJG(); return; } } appStateJG.currentQueueIndex = nextListIndex; const nextSongIdInQueue = appStateJG.queue[appStateJG.currentQueueIndex]; nextSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === nextSongIdInQueue); } else if (appStateJG.playMode === 'playlist' && appStateJG.currentPlayingPlaylistId) { const p = appStateJG.userPlaylists.find(pl => pl.id === appStateJG.currentPlayingPlaylistId); if (p && p.songs.length > 0) { currentList = p.songs.map(id => findSongByIdJG(id)).filter(s => s); nextListIndex = appStateJG.currentQueueIndex + 1; if (nextListIndex >= currentList.length) { if (appStateJG.loopMode === 'all') nextListIndex = 0; else { showSnackbarJG(`プレイリスト「${escapeHTMLJG(p.name)}」終了`, "info"); appStateJG.isPlaying = false; updatePlayPauseButtonJG(); updateDocumentTitleJG(); return; } } appStateJG.currentQueueIndex = nextListIndex; const nextSongIdInPlaylist = p.songs[appStateJG.currentQueueIndex]; nextSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === nextSongIdInPlaylist); } else { appStateJG.playMode = 'library'; appStateJG.currentPlayingPlaylistId = null; appStateJG.currentQueueIndex = -1; } } if (appStateJG.playMode === 'library' || nextSongOriginalIndex === -1) { currentList = appStateJG.isShuffle ? appStateJG.songs : appStateJG.filteredSongs; if (currentList.length === 0) currentList = appStateJG.songs; if (currentList.length === 0) return; if (appStateJG.isShuffle) { if (currentList.length <= 1) nextSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === currentList[0]?.id); else { let rOI, rSId; do { rSId = currentList[Math.floor(Math.random()*currentList.length)].id; rOI = appStateJG.songs.findIndex(s => s.id === rSId); } while (rOI === appStateJG.currentSongIndex && currentList.length > 1); nextSongOriginalIndex = rOI; } } else { let cFI = -1; if (appStateJG.currentSongIndex !== -1) { const cASId = appStateJG.songs[appStateJG.currentSongIndex].id; cFI = appStateJG.filteredSongs.findIndex(s => s.id === cASId); } nextListIndex = (cFI === -1) ? 0 : cFI + 1; if (nextListIndex >= appStateJG.filteredSongs.length) { if (appStateJG.loopMode === 'all') nextListIndex = 0; else { showSnackbarJG("探検終了！", "info"); appStateJG.isPlaying = false; updatePlayPauseButtonJG(); updateDocumentTitleJG(); return; } } if (appStateJG.filteredSongs[nextListIndex]) nextSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === appStateJG.filteredSongs[nextListIndex].id); } } if (nextSongOriginalIndex !== -1) playSongAtIndexJG(nextSongOriginalIndex); else { appStateJG.isPlaying = false; updatePlayPauseButtonJG(); updateDocumentTitleJG(); } }
        function playPrevJG() { /* ... (Same as previous) ... */ if (!appStateJG.songs || appStateJG.songs.length === 0) { showSnackbarJG("リストに曲なし", "info"); return; } if (appStateJG.player && appStateJG.isPlayerReady && appStateJG.player.getCurrentTime && appStateJG.player.getCurrentTime() > SEEK_STEP_JG) { appStateJG.player.seekTo(0); return; } let prevSongOriginalIndex = -1, currentList, prevListIndex; if (appStateJG.playMode === 'queue' && appStateJG.queue.length > 0) { currentList = appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s); prevListIndex = appStateJG.currentQueueIndex - 1; if (prevListIndex < 0) { if (appStateJG.loopMode === 'all' && currentList.length > 0) prevListIndex = currentList.length - 1; else { prevListIndex = 0; if (appStateJG.player && appStateJG.isPlayerReady && appStateJG.player.seekTo) appStateJG.player.seekTo(0); } } appStateJG.currentQueueIndex = prevListIndex; const prevSongIdInQueue = appStateJG.queue[appStateJG.currentQueueIndex]; prevSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === prevSongIdInQueue); } else if (appStateJG.playMode === 'playlist' && appStateJG.currentPlayingPlaylistId) { const p = appStateJG.userPlaylists.find(pl => pl.id === appStateJG.currentPlayingPlaylistId); if (p && p.songs.length > 0) { currentList = p.songs.map(id => findSongByIdJG(id)).filter(s => s); prevListIndex = appStateJG.currentQueueIndex - 1; if (prevListIndex < 0) { if (appStateJG.loopMode === 'all') prevListIndex = currentList.length - 1; else { prevListIndex = 0; if (appStateJG.player && appStateJG.isPlayerReady && appStateJG.player.seekTo) appStateJG.player.seekTo(0); } } appStateJG.currentQueueIndex = prevListIndex; const prevSongIdInPlaylist = p.songs[appStateJG.currentQueueIndex]; prevSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === prevSongIdInPlaylist); } else { appStateJG.playMode = 'library'; appStateJG.currentPlayingPlaylistId = null; appStateJG.currentQueueIndex = -1; } } if (appStateJG.playMode === 'library' || prevSongOriginalIndex === -1) { currentList = appStateJG.isShuffle ? appStateJG.songs : appStateJG.filteredSongs; if (currentList.length === 0) currentList = appStateJG.songs; if (currentList.length === 0) return; if (appStateJG.isShuffle) { if (currentList.length <= 1) prevSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === currentList[0]?.id); else { let rOI, rSId; do { rSId = currentList[Math.floor(Math.random()*currentList.length)].id; rOI = appStateJG.songs.findIndex(s => s.id === rSId); } while (rOI === appStateJG.currentSongIndex && currentList.length > 1); prevSongOriginalIndex = rOI; } } else { let cFI = -1; if (appStateJG.currentSongIndex !== -1) { const cASId = appStateJG.songs[appStateJG.currentSongIndex].id; cFI = appStateJG.filteredSongs.findIndex(s => s.id === cASId); } prevListIndex = cFI - 1; if (prevListIndex < 0) { if (appStateJG.loopMode === 'all' && appStateJG.filteredSongs.length > 0) prevListIndex = appStateJG.filteredSongs.length - 1; else { prevListIndex = 0; if (appStateJG.player && appStateJG.isPlayerReady && appStateJG.player.seekTo) appStateJG.player.seekTo(0); } } if (appStateJG.filteredSongs[prevListIndex]) prevSongOriginalIndex = appStateJG.songs.findIndex(s => s.id === appStateJG.filteredSongs[prevListIndex].id); } } if (prevSongOriginalIndex !== -1) playSongAtIndexJG(prevSongOriginalIndex); }
        function handleSongEndJG() { /* ... (Same as previous) ... */ if (appStateJG.loopMode === 'one' && appStateJG.currentSongIndex !== -1) playSongAtIndexJG(appStateJG.currentSongIndex); else playNextJG(); }
        function updateProgressJG() { /* ... (Same as previous) ... */ if(!appStateJG.player||!appStateJG.isPlayerReady||typeof appStateJG.player.getDuration!=='function'||!elementsJG.progressSlider)return;const curTime=appStateJG.player.getCurrentTime?appStateJG.player.getCurrentTime():0;const dur=appStateJG.player.getDuration?appStateJG.player.getDuration():0;if(elementsJG.progressSlider&&elementsJG.currentTimeDisplay&&elementsJG.totalTimeDisplay){if(dur>0){elementsJG.progressSlider.value=(curTime/dur)*100;elementsJG.currentTimeDisplay.textContent=formatTimeJG(curTime);elementsJG.totalTimeDisplay.textContent=formatTimeJG(dur);const curSong=appStateJG.songs[appStateJG.currentSongIndex];if(curSong&&curSong.duration==="--:--"){curSong.duration=formatTimeJG(dur);document.querySelectorAll(`.log-entry-jg[data-id="${curSong.id}"] .duration`).forEach(el=>{el.textContent=curSong.duration;});}}else{elementsJG.progressSlider.value=0;elementsJG.currentTimeDisplay.textContent="0:00";}}}
        function cyclePlaybackRateJG() { /* ... (Same as previous) ... */ if (!appStateJG.player || !appStateJG.isPlayerReady || typeof appStateJG.player.setPlaybackRate !== 'function') { showSnackbarJG("再生速度変更不可", "warning"); return; } currentPlaybackRateIndexJG = (currentPlaybackRateIndexJG + 1) % PLAYBACK_RATES_JG.length; const newRate = PLAYBACK_RATES_JG[currentPlaybackRateIndexJG]; appStateJG.player.setPlaybackRate(newRate); if (elementsJG.btnPlaybackRate) elementsJG.btnPlaybackRate.textContent = `${newRate}x`; elementsJG.btnPlaybackRate.classList.toggle('active-control', newRate !== 1); saveToLocalStorageJG(LS_KEYS_JG.PLAYBACK_RATE, newRate); showSnackbarJG(`再生速度: ${newRate}x`, "info", 1500); }
        function applyPlaybackRateJG(rate) { /* ... (Same as previous) ... */ if (appStateJG.player && appStateJG.isPlayerReady && typeof appStateJG.player.setPlaybackRate === 'function') { const validRate = PLAYBACK_RATES_JG.includes(rate) ? rate : 1; currentPlaybackRateIndexJG = PLAYBACK_RATES_JG.indexOf(validRate); appStateJG.player.setPlaybackRate(validRate); if (elementsJG.btnPlaybackRate) elementsJG.btnPlaybackRate.textContent = `${validRate}x`; elementsJG.btnPlaybackRate.classList.toggle('active-control', validRate !== 1); } }
        async function togglePictureInPictureJG() { /* ... (Same as previous) ... */ if (!elementsJG.youtubePlayerContainer || !elementsJG.youtubePlayerContainer.firstChild) { showSnackbarJG("PiPターゲットなし", "error"); return; } const videoElement = elementsJG.youtubePlayerContainer.firstChild; if (!document.pictureInPictureEnabled) { showSnackbarJG("ブラウザPiP非対応", "warning"); elementsJG.btnPip.disabled = true; return; } try { if (document.pictureInPictureElement) { await document.exitPictureInPicture(); } else { if (videoElement.requestPictureInPicture) { await videoElement.requestPictureInPicture(); } else { showSnackbarJG("PiP開始失敗", "error"); } } } catch (error) { console.error("PiP Error:", error); showSnackbarJG(`PiPエラー: ${error.message}`, "error"); } }
        function handleEnterPiPJG() { /* ... (Same as previous) ... */ if(elementsJG.btnPip) elementsJG.btnPip.classList.add('active-control'); console.log("Entered PiP mode");}
        function handleLeavePiPJG() { /* ... (Same as previous) ... */ if(elementsJG.btnPip) elementsJG.btnPip.classList.remove('active-control'); console.log("Exited PiP mode");}
        function onPlayerReadyJG(event) { /* ... (Same as previous) ... */ appStateJG.isPlayerReady = true; if (event.target && typeof event.target.setVolume === 'function') { setVolumeJG(appStateJG.volume, false);  } const storedRate = loadFromLocalStorageJG(LS_KEYS_JG.PLAYBACK_RATE); if (storedRate !== null) applyPlaybackRateJG(parseFloat(storedRate)); loadInitialSongsJG(); }
        function onPlayerStateChangeJG(event) { /* ... (Same as previous) ... */ const ps=event.data; if(ps===YT.PlayerState.PLAYING){appStateJG.isPlaying=true;if(appStateJG.progressInterval)clearInterval(appStateJG.progressInterval);appStateJG.progressInterval=setInterval(updateProgressJG,500);updatePlayerUIGJ(appStateJG.songs[appStateJG.currentSongIndex]);updateActiveListItemJG(); const cSO=appStateJG.songs[appStateJG.currentSongIndex];if(cSO){if(appStateJG.playMode==='queue'){const sIQ=appStateJG.queue[appStateJG.currentQueueIndex];if(sIQ!==cSO.id){const nQI=appStateJG.queue.findIndex(id=>id===cSO.id);if(nQI!==-1)appStateJG.currentQueueIndex=nQI;else{appStateJG.playMode='library';appStateJG.currentQueueIndex=-1;}}}else if(appStateJG.playMode==='playlist'&&appStateJG.currentPlayingPlaylistId){const p=appStateJG.userPlaylists.find(pl=>pl.id===appStateJG.currentPlayingPlaylistId);if(p){const sIP=p.songs[appStateJG.currentQueueIndex];if(sIP!==cSO.id){const nPSI=p.songs.findIndex(id=>id===cSO.id);if(nPSI!==-1)appStateJG.currentQueueIndex=nPSI;else{appStateJG.playMode='library';appStateJG.currentPlayingPlaylistId=null;appStateJG.currentQueueIndex=-1;}}}else{appStateJG.playMode='library';appStateJG.currentPlayingPlaylistId=null;appStateJG.currentQueueIndex=-1;}}}} else if(ps===YT.PlayerState.PAUSED){appStateJG.isPlaying=false;clearInterval(appStateJG.progressInterval);updatePlayPauseButtonJG();updateDocumentTitleJG();} else if(ps===YT.PlayerState.ENDED){appStateJG.isPlaying=false;clearInterval(appStateJG.progressInterval);updatePlayPauseButtonJG();updateDocumentTitleJG();if(elementsJG.progressSlider)elementsJG.progressSlider.value=100;if(elementsJG.currentTimeDisplay&&elementsJG.totalTimeDisplay){elementsJG.currentTimeDisplay.textContent=elementsJG.totalTimeDisplay.textContent;}handleSongEndJG();} else if(ps===YT.PlayerState.CUED){updateProgressJG();if(!appStateJG.isPlaying&&appStateJG.currentSongIndex!==-1){appStateJG.player.playVideo();}} else if(ps===-1){updateDocumentTitleJG();} }
        function onPlayerErrorJG(event) { /* ... (Same as previous) ... */ console.error("Player Error:", event.data); let msg=`動画再生エラー(${event.data})`; const cST=appStateJG.songs[appStateJG.currentSongIndex]?.title||"この動画"; switch(event.data){case 2:msg=`「${escapeHTMLJG(cST)}」読込失敗。ID無効等`;break;case 5:msg=`「${escapeHTMLJG(cST)}」HTML5プレイヤーエラー`;break;case 100:msg=`「${escapeHTMLJG(cST)}」が見つかりません`;break;case 101:case 150:msg=`「${escapeHTMLJG(cST)}」埋込再生不可`;break;default:msg=`「${escapeHTMLJG(cST)}」不明なエラー(${event.data})`} showSnackbarJG(msg,"error",7000);appStateJG.isPlaying=false;updatePlayPauseButtonJG();updateDocumentTitleJG(); }
        function updateLogActionButtonsJG(panelIdToUpdate){ /* ... (Same as previous) ... */ const c=document.getElementById('log-actions-container-jg');if(!c)return;c.innerHTML='';const ctxId=appStateJG.currentViewingPlaylistId&&panelIdToUpdate==='log-paths'?'playlistSongs':panelIdToUpdate;const acts=appStateJG.buttonsForPanel[ctxId]||appStateJG.buttonsForPanel['log-library'];acts.forEach(aId=>{let b;switch(aId){case 'btn-refresh-feed-jg':b=document.createElement('button');b.innerHTML='<i class="fas fa-sync-alt"></i> Feed更新';b.addEventListener('click',()=>{showSnackbarJG("情報取得中...","info");loadInitialSongsJG();});break;case 'btn-create-playlist-jg':b=document.createElement('button');b.innerHTML='<i class="fas fa-plus-circle"></i> 新しい道';b.addEventListener('click',showCreatePlaylistModalJG);break;case 'btn-clear-queue-jg':if(appStateJG.queue.length>0){b=document.createElement('button');b.innerHTML='<i class="fas fa-trash-alt"></i> キューを空に';b.addEventListener('click',confirmClearQueueJG);}break;case 'btn-clear-history-jg':if(appStateJG.history.length>0){b=document.createElement('button');b.innerHTML='<i class="fas fa-history"></i> <i class="fas fa-trash-alt"></i> 履歴クリア';b.addEventListener('click',confirmClearHistoryJG);}break;}if(b)c.appendChild(b);});}
        function confirmClearQueueJG(){ /* ... (Same as previous) ... */ if(appStateJG.queue.length===0){showSnackbarJG("キューは空","info");return;}if(confirm("キューを空にしますか？"))clearQueueJG();}
        function clearQueueJG(){ /* ... (Same as previous) ... */ appStateJG.queue=[];appStateJG.currentQueueIndex=-1;saveToLocalStorageJG(LS_KEYS_JG.QUEUE,appStateJG.queue);updateQueueCountBadgeJG();if(appStateJG.currentPanel==='log-discoveries'&&elementsJG.queuePanel)renderSongListJG(elementsJG.queuePanel,[],'queue');showSnackbarJG("キューを空に","success");updateLogActionButtonsJG('log-discoveries');}
        function confirmClearHistoryJG(){ /* ... (Same as previous) ... */ if(appStateJG.history.length===0){showSnackbarJG("再生履歴は空","info");return;}if(confirm("再生履歴を全て削除しますか？"))clearHistoryJG();}
        function clearHistoryJG(){ /* ... (Same as previous) ... */ appStateJG.history=[];saveToLocalStorageJG(LS_KEYS_JG.HISTORY,appStateJG.history);if(appStateJG.currentPanel==='log-history'&&elementsJG.historyPanel)renderHistoryListJG();showSnackbarJG("再生履歴削除","success");updateLogActionButtonsJG('log-history');}
        function setupEventListenersJG() { /* ... (Same as previous, includes new button listeners) ... */ elementsJG.btnPlay?.addEventListener('click', togglePlayPauseJG); elementsJG.btnNext?.addEventListener('click', playNextJG); elementsJG.btnPrev?.addEventListener('click', playPrevJG); elementsJG.btnShuffle?.addEventListener('click', toggleShuffleJG); elementsJG.btnLoop?.addEventListener('click', toggleLoopJG); elementsJG.btnPlaybackRate?.addEventListener('click', cyclePlaybackRateJG); elementsJG.btnPip?.addEventListener('click', togglePictureInPictureJG); elementsJG.progressSlider?.addEventListener('input', (e) => { if(!appStateJG.player||!appStateJG.isPlayerReady||typeof appStateJG.player.getDuration!=='function')return;const d=appStateJG.player.getDuration();if(d>0){const sT=(parseFloat(e.target.value)/100)*d;if(appStateJG.player.seekTo)appStateJG.player.seekTo(sT,true);updateProgressJG();}}); elementsJG.volumeSlider?.addEventListener('input', (e) => setVolumeJG(parseInt(e.target.value))); elementsJG.volumeIconMute?.addEventListener('click', toggleMuteJG); elementsJG.volumeIconUp?.addEventListener('click', () => { if (appStateJG.isMuted) toggleMuteJG(); }); elementsJG.themeToggle?.addEventListener('click', cycleThemeJG); elementsJG.logTabs.forEach(tab => tab.addEventListener('click', () => switchLogPanelJG(tab.dataset.panel))); elementsJG.searchInput?.addEventListener('input', handleSearchJG); elementsJG.clearSearchButton?.addEventListener('click', () => { if(elementsJG.searchInput){elementsJG.searchInput.value='';elementsJG.searchInput.dispatchEvent(new Event('input'));elementsJG.searchInput.focus();}}); document.addEventListener('keydown', handleGlobalKeydownJG); elementsJG.songContextMenu?.addEventListener('click', handleContextMenuActionJG); document.addEventListener('click', hideSongContextMenuJG); elementsJG.confirmEditSongButton?.addEventListener('click', handleConfirmEditSongJG); elementsJG.cancelEditSongButton?.addEventListener('click', hideEditSongModalJG); elementsJG.editSongModal?.addEventListener('click', (e) => { if (e.target === elementsJG.editSongModal) hideEditSongModalJG(); }); if (document.pictureInPictureEnabled && elementsJG.btnPip) elementsJG.btnPip.style.display = 'inline-flex'; }
        function cycleThemeJG() { /* ... (Same as previous) ... */ currentThemeIndexJG = (currentThemeIndexJG + 1) % AVAILABLE_THEMES_JG.length; const newTheme = AVAILABLE_THEMES_JG[currentThemeIndexJG]; applyThemeJG(newTheme.id); saveToLocalStorageJG(LS_KEYS_JG.THEME, newTheme.id); showSnackbarJG(`テーマ: ${newTheme.name}`, "info", 1500); }
        function applyThemeJG(themeId) { /* ... (Same as previous) ... */ elementsJG.body.className = ''; elementsJG.body.classList.add(themeId); const themeObject = AVAILABLE_THEMES_JG.find(t => t.id === themeId); if (themeObject && themeObject.type === 'light') { elementsJG.body.classList.add('modal-light-theme-jg'); } else { elementsJG.body.classList.remove('modal-light-theme-jg'); } }
        function switchLogPanelJG(panelId) { /* ... (Same as previous) ... */ if (!panelId) return;  if (appStateJG.currentViewingPlaylistId && panelId !== 'log-paths') appStateJG.currentViewingPlaylistId = null;  appStateJG.currentPanel = panelId; elementsJG.logTabs.forEach(t => t.classList.toggle('active', t.dataset.panel === panelId)); elementsJG.logPanels.forEach(p => { if (p) p.classList.toggle('active', p.id === panelId);}); switch (panelId) { case 'log-library': if (elementsJG.libraryPanel) renderSongListJG(elementsJG.libraryPanel, appStateJG.filteredSongs, 'library'); break; case 'log-discoveries': if (elementsJG.queuePanel) renderSongListJG(elementsJG.queuePanel, appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s), 'queue'); break; case 'log-trophies': if (elementsJG.favoritesPanel) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites'); break; case 'log-history': if(elementsJG.historyPanel) renderHistoryListJG(); break; case 'log-paths': if(elementsJG.playlistsPanel) { if (appStateJG.currentViewingPlaylistId) renderSongsInPlaylistJG(appStateJG.currentViewingPlaylistId); else renderPlaylistsJG(); } break; } updateLogActionButtonsJG(panelId);  }
        function handleSearchJG() { /* ... (Same as previous) ... */ if(!elementsJG.searchInput||!elementsJG.clearSearchButton)return;const sT=elementsJG.searchInput.value.toLowerCase().trim();elementsJG.clearSearchButton.style.display=sT?'inline-block':'none';if(sT===""){appStateJG.filteredSongs=[...appStateJG.songs];}else{appStateJG.filteredSongs=appStateJG.songs.filter(s=>(getDisplaySongInfoJG(s.id).title.toLowerCase().includes(sT))||(getDisplaySongInfoJG(s.id).artist.toLowerCase().includes(sT)));}if(appStateJG.currentPanel==='log-library'&&elementsJG.libraryPanel)renderSongListJG(elementsJG.libraryPanel,appStateJG.filteredSongs,'library');}
        function toggleShuffleJG() { /* ... (Same as previous) ... */ if(!elementsJG.btnShuffle)return;appStateJG.isShuffle=!appStateJG.isShuffle;elementsJG.btnShuffle.classList.toggle('active-control',appStateJG.isShuffle);showSnackbarJG(`シャッフル ${appStateJG.isShuffle?'ON':'OFF'}!`);}
        function toggleLoopJG() { /* ... (Same as previous) ... */ if (!elementsJG.btnLoop) return; if (appStateJG.loopMode === 'none') appStateJG.loopMode = 'all'; else if (appStateJG.loopMode === 'all') appStateJG.loopMode = 'one'; else appStateJG.loopMode = 'none'; elementsJG.btnLoop.classList.toggle('active-control', appStateJG.loopMode !== 'none'); let ind = elementsJG.btnLoop.querySelector('.loop-indicator-jg'); if (appStateJG.loopMode === 'one') { if (!ind) { ind = document.createElement('span'); ind.className = 'loop-indicator-jg'; elementsJG.btnLoop.appendChild(ind); } ind.textContent = '1'; } else { if (ind) ind.remove(); } let msg="リピート: "; if(appStateJG.loopMode==='none')msg+="OFF"; if(appStateJG.loopMode==='all')msg+="全体"+(appStateJG.playMode==='queue'&&appStateJG.queue.length>0?" (キュー)":""); if(appStateJG.loopMode==='one')msg+="この曲"; showSnackbarJG(msg); }
        function setVolumeJG(volume, save = true) { /* ... (Same as previous) ... */ appStateJG.volume=Math.max(0,Math.min(100,volume));appStateJG.isMuted=(appStateJG.volume===0);if(elementsJG.volumeSlider)elementsJG.volumeSlider.value=appStateJG.volume;if(appStateJG.player&&appStateJG.isPlayerReady&&typeof appStateJG.player.setVolume==='function'){appStateJG.player.setVolume(appStateJG.volume);if(!appStateJG.isMuted&&typeof appStateJG.player.unMute==='function'&&appStateJG.player.isMuted()){appStateJG.player.unMute();}}updateVolumeIconsJG();if(save)saveToLocalStorageJG(LS_KEYS_JG.VOLUME,appStateJG.volume);}
        function toggleMuteJG() { /* ... (Same as previous) ... */ if(appStateJG.isMuted){setVolumeJG(appStateJG.previousVolumeBeforeMute>0?appStateJG.previousVolumeBeforeMute:25);}else{appStateJG.previousVolumeBeforeMute=appStateJG.volume;setVolumeJG(0);}}
        function updateVolumeIconsJG() { /* ... (Same as previous) ... */ if(elementsJG.volumeIconMute&&elementsJG.volumeIconUp){const iEM=appStateJG.volume===0||appStateJG.isMuted;elementsJG.volumeIconMute.style.opacity=iEM?'1':'0.5';elementsJG.volumeIconMute.classList.toggle('text-jg-accent-sunburst',iEM);elementsJG.volumeIconUp.style.opacity=!iEM?'1':'0.5';elementsJG.volumeIconUp.classList.remove('text-jg-accent-sunburst');}}
        function addToHistoryJG(song) { /* ... (Same as previous) ... */ if(!song||!song.id)return;appStateJG.history=appStateJG.history.filter(s=>s.id!==song.id);appStateJG.history.unshift(song);if(appStateJG.history.length>MAX_HISTORY_JG)appStateJG.history.pop();saveToLocalStorageJG(LS_KEYS_JG.HISTORY,appStateJG.history);}
        function renderHistoryListJG() { /* ... (Same as previous) ... */ if (elementsJG.historyPanel) renderSongListJG(elementsJG.historyPanel, appStateJG.history, 'history');}
        function toggleFavoriteJG(songId, iconElement, buttonElement) { /* ... (Same as previous) ... */ const songIndexInFavorites = appStateJG.favorites.findIndex(s => s.id === songId); const song = findSongByIdJG(songId); if (!song) { showSnackbarJG("お気に入り操作エラー: 曲が見つかりません。", "error"); return; } const displayInfo = getDisplaySongInfoJG(songId); let isNowFavorite = false; if (songIndexInFavorites > -1) { appStateJG.favorites.splice(songIndexInFavorites, 1); showSnackbarJG(`「${escapeHTMLJG(displayInfo.title)}」をお気に入りから解除`); } else { appStateJG.favorites.push(song); isNowFavorite = true; showSnackbarJG(`「${escapeHTMLJG(displayInfo.title)}」をお気に入りに追加！`, "success"); } saveToLocalStorageJG(LS_KEYS_JG.FAVORITES, appStateJG.favorites); if (iconElement) iconElement.className = `fas ${isNowFavorite ? 'fa-heart text-jg-accent-sunburst' : 'fa-feather-alt'}`; if (buttonElement) buttonElement.setAttribute('aria-label', isNowFavorite ? 'お気に入りから削除' : 'お気に入りに追加'); if (appStateJG.currentPanel === 'log-trophies' && elementsJG.favoritesPanel) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites'); document.querySelectorAll(`.log-entry-jg[data-id="${songId}"] .favorite-action-jg`).forEach(btn => { const i=btn.querySelector('i'); if(i&&i!==iconElement)i.className=`fas ${isNowFavorite?'fa-heart text-jg-accent-sunburst':'fa-feather-alt'}`; if(btn!==buttonElement)btn.setAttribute('aria-label',isNowFavorite?'お気に入りから削除':'お気に入りに追加');}); }
        function addToQueueJG(songId) { /* ... (Same as previous) ... */ const song = findSongByIdJG(songId); if (!song) { showSnackbarJG("曲が見つかりません。", "error"); return; } const displayInfo = getDisplaySongInfoJG(songId); appStateJG.queue.push(songId); saveToLocalStorageJG(LS_KEYS_JG.QUEUE, appStateJG.queue); updateQueueCountBadgeJG(); showSnackbarJG(`「${escapeHTMLJG(displayInfo.title)}」をキューに追加しました。`, "success"); if (appStateJG.currentPanel === 'log-discoveries' && elementsJG.queuePanel) renderSongListJG(elementsJG.queuePanel, appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s), 'queue'); updateLogActionButtonsJG('log-discoveries');  }
        function updateQueueCountBadgeJG() { /* ... (Same as previous) ... */ if(elementsJG.queueCountBadge){elementsJG.queueCountBadge.textContent=appStateJG.queue.length;elementsJG.queueCountBadge.style.display=appStateJG.queue.length>0?'inline-block':'none';}}
        function generateUniqueIdJG(){ /* ... (Same as previous) ... */ return Date.now().toString(36)+Math.random().toString(36).substring(2);}
        function showCreatePlaylistModalJG(){ /* ... (Same as previous) ... */ const m=document.getElementById('createPlaylistModalJG'),i=document.getElementById('newPlaylistNameJG');if(!m||!i)return;i.value='';m.style.display='flex';appStateJG.activeModalId='createPlaylistModalJG';i.focus();const cB=document.getElementById('confirmCreatePlaylistJG'),canB=document.getElementById('cancelCreatePlaylistJG');const hC=()=>{const pN=i.value.trim();if(pN){createPlaylistJG(pN);hideCreatePlaylistModalJG();}else{showSnackbarJG("プレイリスト名を入力","warning");i.focus();}};const hCan=()=>hideCreatePlaylistModalJG();const hK=(e)=>{if(e.key==='Enter')hC();else if(e.key==='Escape')hCan();};const hBC=(e)=>{if(e.target===m)hCan();};cB._hC=hC;canB._hCan=hCan;i._hK=hK;m._hBC=hBC;cB.addEventListener('click',hC);canB.addEventListener('click',hCan);i.addEventListener('keydown',hK);m.addEventListener('click',hBC);}
        function hideCreatePlaylistModalJG(){ /* ... (Same as previous) ... */ const m=document.getElementById('createPlaylistModalJG');if(!m)return;m.style.display='none';appStateJG.activeModalId=null;const cB=document.getElementById('confirmCreatePlaylistJG'),canB=document.getElementById('cancelCreatePlaylistJG'),i=document.getElementById('newPlaylistNameJG');if(cB&&cB._hC)cB.removeEventListener('click',cB._hC);if(canB&&canB._hCan)canB.removeEventListener('click',canB._hCan);if(i&&i._hK)i.removeEventListener('keydown',i._hK);if(m._hBC)m.removeEventListener('click',m._hBC);}
        function createPlaylistJG(name){ /* ... (Same as previous) ... */ const nP={id:generateUniqueIdJG(),name:name,songs:[]};appStateJG.userPlaylists.push(nP);saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);showSnackbarJG(`プレイリスト「${escapeHTMLJG(name)}」作成！`,"success");if(appStateJG.currentPanel==='log-paths'&&elementsJG.playlistsPanel)renderPlaylistsJG();}
        function renderPlaylistsJG(){ /* ... (Same as previous) ... */ if(!elementsJG.playlistsPanel)return;elementsJG.playlistsPanel.innerHTML='';appStateJG.currentViewingPlaylistId=null;if(appStateJG.userPlaylists.length===0){showEmptyMessageInPanelJG(elementsJG.playlistsPanel,"道はまだ描かれていない","「新しい道」から作成！");updateLogActionButtonsJG('log-paths');return;}const frag=document.createDocumentFragment();appStateJG.userPlaylists.forEach(p=>{const pE=document.createElement('div');pE.className='log-entry-jg playlist-item-jg';pE.dataset.playlistId=p.id;pE.innerHTML=`<i class="fas fa-compact-disc fa-lg mr-3 text-jg-accent-waterfall" style="width:40px;text-align:center;flex-shrink:0;"></i><div><span class="title">${escapeHTMLJG(p.name)}</span><span class="artist">${p.songs.length} 曲</span></div><div class="log-entry-actions-jg"><button class="song-item-action-jg rename-playlist-action-jg" title="名前変更"><i class="fas fa-pencil-alt"></i></button><button class="song-item-action-jg delete-playlist-action-jg" title="削除"><i class="fas fa-trash-alt"></i></button></div>`;pE.addEventListener('click',(e)=>{if(e.target.closest('.song-item-action-jg'))return;renderSongsInPlaylistJG(p.id);});pE.querySelector('.rename-playlist-action-jg')?.addEventListener('click',(e)=>{e.stopPropagation();const nN=prompt(`プレイリスト「${escapeHTMLJG(p.name)}」新名称:`,p.name);if(nN&&nN.trim()!==""&&nN.trim()!==p.name)renamePlaylistJG(p.id,nN.trim());else if(nN!==null)showSnackbarJG("名称変更なし","info");});pE.querySelector('.delete-playlist-action-jg')?.addEventListener('click',(e)=>{e.stopPropagation();confirmDeletePlaylistJG(p.id,p.name);});frag.appendChild(pE);});elementsJG.playlistsPanel.appendChild(frag);updateLogActionButtonsJG('log-paths');}
        function renamePlaylistJG(playlistId,newName){ /* ... (Same as previous) ... */ const p=appStateJG.userPlaylists.find(pl=>pl.id===playlistId);if(p){const oN=p.name;p.name=newName;saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);showSnackbarJG(`プレイリスト「${escapeHTMLJG(oN)}」を「${escapeHTMLJG(newName)}」に改名`,"success");if(appStateJG.currentPanel==='log-paths'){if(appStateJG.currentViewingPlaylistId===playlistId){const hT=elementsJG.playlistsPanel?.querySelector('h4.font-display-jg');if(hT)hT.textContent=escapeHTMLJG(newName);}else renderPlaylistsJG();}}else showSnackbarJG("プレイリスト改名失敗","error");}
        function confirmDeletePlaylistJG(playlistId,playlistName){ /* ... (Same as previous) ... */ if(confirm(`プレイリスト「${escapeHTMLJG(playlistName)}」を削除しますか？`))deletePlaylistJG(playlistId);}
        function deletePlaylistJG(playlistId){ /* ... (Same as previous) ... */ appStateJG.userPlaylists=appStateJG.userPlaylists.filter(p=>p.id!==playlistId);saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);showSnackbarJG("プレイリスト削除","info");if(appStateJG.currentViewingPlaylistId===playlistId)appStateJG.currentViewingPlaylistId=null;if(appStateJG.currentPlayingPlaylistId===playlistId){appStateJG.currentPlayingPlaylistId=null;appStateJG.playMode='library';appStateJG.currentQueueIndex=-1;}if(appStateJG.currentPanel==='log-paths'&&elementsJG.playlistsPanel)renderPlaylistsJG();}
        let currentSongIdForPlaylistAddition=null;
        function showAddToPlaylistModalJG(songId){ /* ... (Same as previous) ... */ const m=document.getElementById('addToPlaylistModalJG'),pLD=document.getElementById('addToPlaylistListJG'),sTD=document.getElementById('addToPlaylistSongTitleJG');if(!m||!pLD||!sTD)return;currentSongIdForPlaylistAddition=songId;const s=findSongByIdJG(songId);if(s){const dI=getDisplaySongInfoJG(s.id);sTD.textContent=`曲: ${escapeHTMLJG(dI.title)}`;}else sTD.textContent='曲選択中...';pLD.innerHTML='';if(appStateJG.userPlaylists.length===0)pLD.innerHTML=`<p class="p-4 text-center text-jg-text-shadow">プレイリストなし。「新しい道」から作成。</p>`;else{const lF=document.createDocumentFragment();appStateJG.userPlaylists.forEach(p=>{const item=document.createElement('div');item.className='playlist-select-item-jg';item.textContent=escapeHTMLJG(p.name)+` (${p.songs.length}曲)`;item.dataset.playlistId=p.id;item.addEventListener('click',()=>{addSongToPlaylistJG(currentSongIdForPlaylistAddition,p.id);hideAddToPlaylistModalJG();});lF.appendChild(item);});pLD.appendChild(lF);}m.style.display='flex';appStateJG.activeModalId='addToPlaylistModalJG';const cB=document.getElementById('cancelAddToPlaylistJG');const hC=()=>hideAddToPlaylistModalJG();const hBC=(e)=>{if(e.target===m)hC();};m._hBC=hBC;cB._hC=hC;cB.addEventListener('click',hC);m.addEventListener('click',hBC);}
        function hideAddToPlaylistModalJG(){ /* ... (Same as previous) ... */ const m=document.getElementById('addToPlaylistModalJG');if(m){m.style.display='none';const cB=document.getElementById('cancelAddToPlaylistJG');if(cB&&cB._hC){cB.removeEventListener('click',cB._hC);delete cB._hC;}if(m._hBC){m.removeEventListener('click',m._hBC);delete m._hBC;}}appStateJG.activeModalId=null;currentSongIdForPlaylistAddition=null;}
        function addSongToPlaylistJG(songId,playlistId){ /* ... (Same as previous) ... */ if(!songId||!playlistId)return;const p=appStateJG.userPlaylists.find(pl=>pl.id===playlistId);const s=findSongByIdJG(songId);if(!p||!s){showSnackbarJG("プレイリスト/曲なし","error");return;}if(p.songs.includes(songId)){showSnackbarJG(`「${escapeHTMLJG(getDisplaySongInfoJG(s.id).title)}」は既にプレイリスト「${escapeHTMLJG(p.name)}」にあり`,"info");return;}p.songs.push(songId);saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);showSnackbarJG(`「${escapeHTMLJG(getDisplaySongInfoJG(s.id).title)}」をプレイリスト「${escapeHTMLJG(p.name)}」に追加`,"success");if(appStateJG.currentPanel==='log-paths'&&elementsJG.playlistsPanel){if(appStateJG.currentViewingPlaylistId===playlistId)renderSongsInPlaylistJG(playlistId);else{const pI=elementsJG.playlistsPanel.querySelector(`.playlist-item-jg[data-playlist-id="${playlistId}"] .artist`);if(pI)pI.textContent=`${p.songs.length} 曲`;}}}
        function confirmRemoveSongFromPlaylistJG(songId,playlistId,songTitle){ /* ... (Same as previous) ... */ const p=appStateJG.userPlaylists.find(pl=>pl.id===playlistId);if(!p)return;const dI=getDisplaySongInfoJG(songId);const eST=escapeHTMLJG(dI.title)||"この曲";const ePN=escapeHTMLJG(p.name)||"このプレイリスト";if(confirm(`曲「${eST}」をプレイリスト「${ePN}」から削除しますか？`))removeSongFromPlaylistJG(songId,playlistId);}
        function removeSongFromPlaylistJG(songId,playlistId){ /* ... (Same as previous) ... */ const p=appStateJG.userPlaylists.find(pl=>pl.id===playlistId);if(!p){showSnackbarJG("プレイリストなし","error");return;}const sIIP=p.songs.indexOf(songId);if(sIIP>-1){p.songs.splice(sIIP,1);saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);showSnackbarJG("曲をプレイリストから削除","success");if(appStateJG.currentPanel==='log-paths'&&appStateJG.currentViewingPlaylistId===playlistId)renderSongsInPlaylistJG(playlistId);}else showSnackbarJG("曲がプレイリストにない","info");}
        function renderSongsInPlaylistJG(playlistId){ /* ... (Same as previous) ... */ if(!elementsJG.playlistsPanel)return;appStateJG.currentViewingPlaylistId=playlistId;const p=appStateJG.userPlaylists.find(pl=>pl.id===playlistId);if(!p){elementsJG.playlistsPanel.innerHTML=`<div class="flex items-center justify-between mb-3 px-1"><h4 class="font-display-jg text-xl text-jg-text-earth">プレイリストエラー</h4><button id="backToPlaylistsViewErrorJG" class="px-3 py-1 rounded bg-jg-surface-leaf hover:bg-jg-accent-canopy text-sm transition-colors"><i class="fas fa-arrow-left mr-1"></i> 道一覧へ</button></div><div class="text-center p-4 text-jg-text-shadow">指定プレイリストなし</div>`;document.getElementById('backToPlaylistsViewErrorJG')?.addEventListener('click',()=>{appStateJG.currentViewingPlaylistId=null;renderPlaylistsJG();updateLogActionButtonsJG('log-paths');});updateLogActionButtonsJG('log-paths');return;}elementsJG.playlistsPanel.innerHTML='';const hD=document.createElement('div');hD.className='flex items-center justify-between mb-3 px-1';hD.innerHTML=`<div><h4 class="font-display-jg text-xl text-jg-text-earth">${escapeHTMLJG(p.name)}</h4><p class="text-sm text-jg-text-shadow">${p.songs.length} 曲</p></div><button id="backToPlaylistsViewJG" class="px-3 py-1 rounded bg-jg-surface-leaf hover:bg-jg-accent-canopy text-sm transition-colors"><i class="fas fa-arrow-left mr-1"></i> 道一覧へ</button>`;elementsJG.playlistsPanel.appendChild(hD);document.getElementById('backToPlaylistsViewJG').addEventListener('click',()=>{appStateJG.currentViewingPlaylistId=null;renderPlaylistsJG();});const sLC=document.createElement('div');sLC.className='playlist-songs-container-jg';elementsJG.playlistsPanel.appendChild(sLC);const sIP=p.songs.map(sId=>findSongByIdJG(sId)).filter(s=>s);if(sIP.length===0)showEmptyMessageInPanelJG(sLC,"この道はまだ静かだ...","曲を追加して冒険開始！");else renderSongListJG(sLC,sIP,'playlistSongs');updateLogActionButtonsJG('log-paths');}
        function handleDragStartJG(event,songId,originalListIndex,context){ /* ... (Same as previous) ... */ if(!event.target.classList.contains('log-entry-jg'))return;draggedItemJG=event.target;draggedItemOriginalIndexJG=originalListIndex;currentDragContextJG=context;event.dataTransfer.setData('text/plain',songId);event.dataTransfer.effectAllowed='move';draggedItemJG.classList.add('dragging-jg');draggedItemJG.style.cursor='grabbing';}
        function handleDragOverJG(event){ /* ... (Same as previous) ... */ event.preventDefault();event.dataTransfer.dropEffect='move';if(!draggedItemJG)return;const tI=event.target.closest('.log-entry-jg');const cont=draggedItemJG.parentElement;if(!dragOverPlaceholderJG){dragOverPlaceholderJG=document.createElement('div');dragOverPlaceholderJG.className='drag-over-placeholder-jg';}if(tI&&tI!==draggedItemJG){const r=tI.getBoundingClientRect();const iA=event.clientY>r.top+r.height/2;if(iA)cont.insertBefore(dragOverPlaceholderJG,tI.nextSibling);else cont.insertBefore(dragOverPlaceholderJG,tI);}else if(!tI&&cont.contains(draggedItemJG)){const lC=cont.lastElementChild;if(lC&&lC!==dragOverPlaceholderJG&&lC!==draggedItemJG){if(event.clientY>lC.getBoundingClientRect().bottom-10)cont.appendChild(dragOverPlaceholderJG);}else if(!lC||lC===draggedItemJG)cont.appendChild(dragOverPlaceholderJG);}}
        function handleDragLeaveJG(event){ /* ... (Same as previous) ... */ }
        function handleDropJG(event,panelElement,context){ /* ... (Same as previous) ... */ event.preventDefault();if(!draggedItemJG||currentDragContextJG!==context){cleanupDragStateJG();return;}const dSId=event.dataTransfer.getData('text/plain');let lTU;if(context==='queue')lTU=appStateJG.queue;else if(context==='playlistSongs'&&appStateJG.currentViewingPlaylistId){const p=appStateJG.userPlaylists.find(pl=>pl.id===appStateJG.currentViewingPlaylistId);if(p)lTU=p.songs;else{cleanupDragStateJG();return;}}else{cleanupDragStateJG();return;}const oI=lTU.indexOf(dSId);if(oI===-1){cleanupDragStateJG();return;}let nI=-1;if(dragOverPlaceholderJG&&dragOverPlaceholderJG.parentElement){const ch=Array.from(dragOverPlaceholderJG.parentElement.children);nI=ch.indexOf(dragOverPlaceholderJG);}else{const dOI=event.target.closest('.log-entry-jg');if(dOI&&dOI!==draggedItemJG){const dOId=dOI.dataset.id;nI=lTU.indexOf(dOId);const r=dOI.getBoundingClientRect();if(event.clientY>r.top+r.height/2)nI++;}else nI=lTU.length;}if(nI===-1){cleanupDragStateJG();return;}const[mSId]=lTU.splice(oI,1);if(nI>oI)nI--;lTU.splice(Math.max(0,Math.min(nI,lTU.length)),0,mSId);if(context==='queue'){appStateJG.queue=lTU;saveToLocalStorageJG(LS_KEYS_JG.QUEUE,appStateJG.queue);renderSongListJG(panelElement,appStateJG.queue.map(id=>findSongByIdJG(id)).filter(s=>s),'queue');if(appStateJG.playMode==='queue'&&appStateJG.currentSongIndex!==-1){const cPSId=appStateJG.songs[appStateJG.currentSongIndex].id;appStateJG.currentQueueIndex=appStateJG.queue.indexOf(cPSId);}}else if(context==='playlistSongs'){saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS,appStateJG.userPlaylists);renderSongsInPlaylistJG(appStateJG.currentViewingPlaylistId);if(appStateJG.playMode==='playlist'&&appStateJG.currentPlayingPlaylistId===appStateJG.currentViewingPlaylistId&&appStateJG.currentSongIndex!==-1){const cPSId=appStateJG.songs[appStateJG.currentSongIndex].id;const p=appStateJG.userPlaylists.find(pl=>pl.id===appStateJG.currentPlayingPlaylistId);if(p)appStateJG.currentQueueIndex=p.songs.indexOf(cPSId);}}cleanupDragStateJG();}
        function handleDragEndJG(event){ /* ... (Same as previous) ... */ if(draggedItemJG){draggedItemJG.classList.remove('dragging-jg');draggedItemJG.style.cursor='grab';}cleanupDragStateJG();}
        function cleanupDragStateJG(){ /* ... (Same as previous) ... */ if(dragOverPlaceholderJG&&dragOverPlaceholderJG.parentElement)dragOverPlaceholderJG.remove();dragOverPlaceholderJG=null;draggedItemJG=null;draggedItemOriginalIndexJG=-1;currentDragContextJG=null;}
        function getDisplaySongInfoJG(songId) { /* ... (Same as previous) ... */ const originalSong = findSongByIdJG(songId); if (!originalSong) return { id: songId, title: '不明な曲', artist: '不明なアーティスト', thumbnail: null }; const override = songMetadataOverridesJG[songId]; return { id: originalSong.id, title: override?.title || originalSong.title, artist: override?.artist || originalSong.artist, thumbnail: originalSong.thumbnail, duration: originalSong.duration }; }
        function showEditSongModalJG(songId) { /* ... (Same as previous) ... */ currentEditingSongIdJG = songId; const displayInfo = getDisplaySongInfoJG(songId); if (elementsJG.editSongTitleInput) elementsJG.editSongTitleInput.value = displayInfo.title; if (elementsJG.editSongArtistInput) elementsJG.editSongArtistInput.value = displayInfo.artist; if (elementsJG.editSongModal) { elementsJG.editSongModal.style.display = 'flex'; appStateJG.activeModalId = 'editSongModalJG'; elementsJG.editSongTitleInput?.focus(); } }
        function hideEditSongModalJG() { /* ... (Same as previous) ... */ if (elementsJG.editSongModal) elementsJG.editSongModal.style.display = 'none'; appStateJG.activeModalId = null; currentEditingSongIdJG = null; }
        function handleConfirmEditSongJG() { /* ... (Same as previous) ... */ if (!currentEditingSongIdJG) return; const newTitle = elementsJG.editSongTitleInput?.value.trim(); const newArtist = elementsJG.editSongArtistInput?.value.trim(); const originalSong = findSongByIdJG(currentEditingSongIdJG); if (!originalSong) { showSnackbarJG("編集対象の曲なし", "error"); hideEditSongModalJG(); return; } let changed = false; if (newTitle && newTitle !== originalSong.title) { if (!songMetadataOverridesJG[currentEditingSongIdJG]) songMetadataOverridesJG[currentEditingSongIdJG] = {}; songMetadataOverridesJG[currentEditingSongIdJG].title = newTitle; changed = true; } else if (songMetadataOverridesJG[currentEditingSongIdJG]?.title && newTitle === originalSong.title) { delete songMetadataOverridesJG[currentEditingSongIdJG].title; changed = true; } if (newArtist && newArtist !== originalSong.artist) { if (!songMetadataOverridesJG[currentEditingSongIdJG]) songMetadataOverridesJG[currentEditingSongIdJG] = {}; songMetadataOverridesJG[currentEditingSongIdJG].artist = newArtist; changed = true; } else if (songMetadataOverridesJG[currentEditingSongIdJG]?.artist && newArtist === originalSong.artist) { delete songMetadataOverridesJG[currentEditingSongIdJG].artist; changed = true; } if (songMetadataOverridesJG[currentEditingSongIdJG] && Object.keys(songMetadataOverridesJG[currentEditingSongIdJG]).length === 0) { delete songMetadataOverridesJG[currentEditingSongIdJG]; } if (changed) { saveToLocalStorageJG(LS_KEYS_JG.METADATA_OVERRIDES, songMetadataOverridesJG); showSnackbarJG("曲情報更新", "success"); switchLogPanelJG(appStateJG.currentPanel); if (appStateJG.currentSongIndex !== -1 && appStateJG.songs[appStateJG.currentSongIndex].id === currentEditingSongIdJG) { updatePlayerUIGJ(appStateJG.songs[appStateJG.currentSongIndex]); } } else { showSnackbarJG("情報変更なし", "info"); } hideEditSongModalJG(); }
        function showSongContextMenuJG(x, y, songId) { /* ... (Same as previous) ... */ hideSongContextMenuJG(); currentContextMenuSongIdJG = songId; if (elementsJG.songContextMenu) { elementsJG.songContextMenu.style.top = `${y}px`; elementsJG.songContextMenu.style.left = `${x}px`; elementsJG.songContextMenu.style.display = 'block'; } }
        function hideSongContextMenuJG() { /* ... (Same as previous) ... */ if (elementsJG.songContextMenu) elementsJG.songContextMenu.style.display = 'none'; currentContextMenuSongIdJG = null; }
        function handleContextMenuActionJG(event) { /* ... (Same as previous) ... */ if (!currentContextMenuSongIdJG || !event.target.dataset.action) { hideSongContextMenuJG(); return; } const action = event.target.dataset.action; switch (action) { case 'edit-song': showEditSongModalJG(currentContextMenuSongIdJG); break; } hideSongContextMenuJG(); }
        function findSongByIdJG(songId) { /* ... (Same as previous) ... */ if(!songId||!appStateJG.songs)return null;return appStateJG.songs.find(s=>s&&s.id===songId);}
        function formatTimeJG(seconds) { /* ... (Same as previous) ... */ if(isNaN(seconds)||seconds<0)return '0:00';const m=Math.floor(seconds/60);const s=Math.floor(seconds%60);return `${m}:${s.toString().padStart(2,'0')}`;}
        function escapeHTMLJG(str) { /* ... (Same as previous) ... */ if(typeof str!=='string'||!str)return '';const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};return str.replace(/[&<>"']/g,function(m){return map[m];});}
        function saveToLocalStorageJG(key,data){ /* ... (Same as previous) ... */ try{localStorage.setItem(key,JSON.stringify(data));}catch(e){console.error("LocalStorage Save Error:",key,e);showSnackbarJG("設定保存失敗","error");}}
        function loadFromLocalStorageJG(key){ /* ... (Same as previous) ... */ try{const d=localStorage.getItem(key);return d?JSON.parse(d):null;}catch(e){console.error("LocalStorage Load Error:",key,e);return null;}}
        function showSnackbarJG(message,type='info',duration=3000){ /* ... (Same as previous) ... */ const sId='snackbar-jg-dynamic';let s=document.getElementById(sId);if(!s){s=document.createElement('div');s.id=sId;Object.assign(s.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%) translateY(100px)',padding:'12px 25px',color:'#ecf0f1',borderRadius:'8px',boxShadow:'0 4px 15px rgba(0,0,0,0.3)',zIndex:'10001',opacity:'0',transition:'opacity 0.3s ease, transform 0.3s ease-out',fontSize:'0.9rem',fontFamily:'var(--font-body-jg,sans-serif)',textAlign:'center',minWidth:'280px',maxWidth:'90%'});document.body.appendChild(s);}s.textContent=message;let bgC='#34495e';if(type==='error')bgC='#c0392b';if(type==='success')bgC='#27ae60';if(type==='warning')bgC='#f39c12';s.style.backgroundColor=bgC;requestAnimationFrame(()=>{s.style.opacity='1';s.style.transform='translateX(-50%) translateY(0)';});if(appStateJG.snackbarTimeoutId)clearTimeout(appStateJG.snackbarTimeoutId);appStateJG.snackbarTimeoutId=setTimeout(()=>{s.style.opacity='0';s.style.transform='translateX(-50%) translateY(100px)';},duration);}
        function handleGlobalKeydownJG(event) { /* ... (Same as previous) ... */ const tTN=event.target.tagName.toLowerCase();if(tTN==='input'||tTN==='textarea'||event.target.isContentEditable){if(event.key==='Escape'&&appStateJG.activeModalId){if(appStateJG.activeModalId==='createPlaylistModalJG')hideCreatePlaylistModalJG();else if(appStateJG.activeModalId==='addToPlaylistModalJG')hideAddToPlaylistModalJG();else if(appStateJG.activeModalId==='editSongModalJG')hideEditSongModalJG();}return;}let pD=true;switch(event.key){case ' ':togglePlayPauseJG();break;case 'm':case 'M':toggleMuteJG();break;case 'ArrowRight':if(appStateJG.player&&appStateJG.isPlayerReady&&appStateJG.player.getCurrentTime){appStateJG.player.seekTo(appStateJG.player.getCurrentTime()+SEEK_STEP_JG,true);updateProgressJG();}break;case 'ArrowLeft':if(appStateJG.player&&appStateJG.isPlayerReady&&appStateJG.player.getCurrentTime){appStateJG.player.seekTo(Math.max(0,appStateJG.player.getCurrentTime()-SEEK_STEP_JG),true);updateProgressJG();}break;case 'ArrowUp':setVolumeJG(appStateJG.volume+VOLUME_STEP_JG);break;case 'ArrowDown':setVolumeJG(appStateJG.volume-VOLUME_STEP_JG);break;case 'n':case 'N':playNextJG();break;case 'p':case 'P':case 'b':case 'B':playPrevJG();break;case 's':case 'S':toggleShuffleJG();break;case 'l':case 'L':toggleLoopJG();break;case 'Escape':if(appStateJG.activeModalId){if(appStateJG.activeModalId==='createPlaylistModalJG')hideCreatePlaylistModalJG();else if(appStateJG.activeModalId==='addToPlaylistModalJG')hideAddToPlaylistModalJG();else if(appStateJG.activeModalId==='editSongModalJG')hideEditSongModalJG();}else pD=false;break;default:pD=false;break;}if(pD)event.preventDefault();}
        
        function loadInitialDataJG(isSongDataReload = false) { /* ... (Same as previous) ... */ if (!isSongDataReload) { const storedThemeId = loadFromLocalStorageJG(LS_KEYS_JG.THEME) || AVAILABLE_THEMES_JG[0].id; const foundThemeIndex = AVAILABLE_THEMES_JG.findIndex(t => t.id === storedThemeId); currentThemeIndexJG = (foundThemeIndex !== -1) ? foundThemeIndex : 0; applyThemeJG(AVAILABLE_THEMES_JG[currentThemeIndexJG].id); const storedVolume = loadFromLocalStorageJG(LS_KEYS_JG.VOLUME); if (storedVolume !== null) { appStateJG.volume=parseInt(storedVolume,10);appStateJG.isMuted=(appStateJG.volume===0);appStateJG.previousVolumeBeforeMute=appStateJG.volume>0?appStateJG.volume:75;} if(elementsJG.volumeSlider) elementsJG.volumeSlider.value = appStateJG.volume; updateVolumeIconsJG(); const storedRate = loadFromLocalStorageJG(LS_KEYS_JG.PLAYBACK_RATE); if (storedRate !== null) { const rate = parseFloat(storedRate); if (PLAYBACK_RATES_JG.includes(rate)) { currentPlaybackRateIndexJG = PLAYBACK_RATES_JG.indexOf(rate); if (elementsJG.btnPlaybackRate) elementsJG.btnPlaybackRate.textContent = `${rate}x`; elementsJG.btnPlaybackRate?.classList.toggle('active-control', rate !== 1); } } songMetadataOverridesJG = loadFromLocalStorageJG(LS_KEYS_JG.METADATA_OVERRIDES) || {}; } appStateJG.history = (loadFromLocalStorageJG(LS_KEYS_JG.HISTORY) || []).map(hS => findSongByIdJG(hS.id) || hS).filter(s => s.id); appStateJG.favorites = (loadFromLocalStorageJG(LS_KEYS_JG.FAVORITES) || []).map(fS => findSongByIdJG(fS.id) || fS).filter(s => s.id); appStateJG.queue = (loadFromLocalStorageJG(LS_KEYS_JG.QUEUE) || []).filter(id => findSongByIdJG(id)); appStateJG.userPlaylists = (loadFromLocalStorageJG(LS_KEYS_JG.PLAYLISTS) || []).map(p => ({ ...p, songs: (p.songs || []).filter(id => findSongByIdJG(id)) })); saveToLocalStorageJG(LS_KEYS_JG.HISTORY, appStateJG.history); saveToLocalStorageJG(LS_KEYS_JG.FAVORITES, appStateJG.favorites); saveToLocalStorageJG(LS_KEYS_JG.QUEUE, appStateJG.queue); saveToLocalStorageJG(LS_KEYS_JG.PLAYLISTS, appStateJG.userPlaylists); if (elementsJG.favoritesPanel && (appStateJG.currentPanel === 'log-trophies' || isSongDataReload)) renderSongListJG(elementsJG.favoritesPanel, appStateJG.favorites, 'favorites'); if (elementsJG.historyPanel && (appStateJG.currentPanel === 'log-history' || isSongDataReload)) renderHistoryListJG(); if (elementsJG.queuePanel && (appStateJG.currentPanel === 'log-discoveries' || isSongDataReload)) renderSongListJG(elementsJG.queuePanel, appStateJG.queue.map(id => findSongByIdJG(id)).filter(s => s), 'queue'); if (elementsJG.playlistsPanel && (appStateJG.currentPanel === 'log-paths' || isSongDataReload)) { if (appStateJG.currentViewingPlaylistId) renderSongsInPlaylistJG(appStateJG.currentViewingPlaylistId); else renderPlaylistsJG(); } updateQueueCountBadgeJG(); }

        document.addEventListener('DOMContentLoaded', () => {
            initializeElementsJG();    
            loadInitialDataJG(false);  
            setupEventListenersJG();   
            updatePlayerUIGJ(null); 
            if (elementsJG.btnShuffle) elementsJG.btnShuffle.classList.toggle('active-control', appStateJG.isShuffle);
            if (elementsJG.btnLoop) {  elementsJG.btnLoop.classList.toggle('active-control',appStateJG.loopMode!=='none');let lI=elementsJG.btnLoop.querySelector('.loop-indicator-jg');if(appStateJG.loopMode==='one'){if(!lI){lI=document.createElement('span');lI.className='loop-indicator-jg';elementsJG.btnLoop.appendChild(lI);}lI.textContent='1';}else if(lI)lI.remove();}
            if (elementsJG.searchInput && elementsJG.clearSearchButton) elementsJG.clearSearchButton.style.display = elementsJG.searchInput.value ? 'inline-block' : 'none';
            switchLogPanelJG(appStateJG.currentPanel || 'log-library'); 
            console.log("Jungle Groove Ready!");
        });
    </script>
</body>
</html>
